<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专 拽  -  转拽 砖 INR</title>
    <link rel="icon" type="image/png" href="INR_Logo_v1.png">
    <link rel="apple-touch-icon" href="INR_Logo_v1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <script src="config.js"></script>
    <script src="login.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
        
        /* Dashboard Width Classes */
        .dashboard-width-small { max-width: 1024px; }  /* lg breakpoint */
        .dashboard-width-medium { max-width: 1600px; } /* wider medium */
        .dashboard-width-large { width: 100%; }        /* full width */
        
        /* Smooth transitions for width changes */
        #mainContainer { transition: max-width 0.3s ease-in-out; }
        
        /* Font Scale Classes */
        .font-scale-small { font-size: 0.875rem; }     /* 14px base */
        .font-scale-normal { font-size: 1rem; }        /* 16px base */
        .font-scale-large { font-size: 1.125rem; }     /* 18px base */
        .font-scale-xl { font-size: 1.25rem; }         /* 20px base */
        .font-scale-xxl { font-size: 1.375rem; }       /* 22px base */
        
        /* Scale headings proportionally */
        .font-scale-small h1 { font-size: 1.5rem; }
        .font-scale-small h2 { font-size: 1.25rem; }
        .font-scale-small h3 { font-size: 1.125rem; }
        
        .font-scale-normal h1 { font-size: 1.875rem; }
        .font-scale-normal h2 { font-size: 1.5rem; }
        .font-scale-normal h3 { font-size: 1.25rem; }
        
        .font-scale-large h1 { font-size: 2rem; }
        .font-scale-large h2 { font-size: 1.625rem; }
        .font-scale-large h3 { font-size: 1.375rem; }
        
        .font-scale-xl h1 { font-size: 2.25rem; }
        .font-scale-xl h2 { font-size: 1.875rem; }
        .font-scale-xl h3 { font-size: 1.5rem; }
        
        .font-scale-xxl h1 { font-size: 2.5rem; }
        .font-scale-xxl h2 { font-size: 2rem; }
        .font-scale-xxl h3 { font-size: 1.75rem; }
        
        /* Smooth transitions for font changes */
        body { transition: font-size 0.3s ease-in-out; }
        h1, h2, h3, h4, h5, h6 { transition: font-size 0.3s ease-in-out; }
        
        /* Brand colors inspired by new logo */
        .brand-gradient { background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%); }
        .brand-text-primary { color: #FF6B6B; }
        .brand-text-secondary { color: #45B7D1; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container { position: relative; height: 300px; }
        .stability-ring { stroke-dasharray: 151; stroke-dashoffset: 151; animation: fillRing 2s ease-out forwards; }
        @keyframes fillRing { to { stroke-dashoffset: calc(151 - (151 * var(--progress)) / 100); } }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Drag and Drop Styles */
        .dashboard-card {
            transition: all 0.2s ease;
            position: relative;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .dashboard-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg) scale(1.05);
            z-index: 1000;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .dashboard-card.drag-over {
            border: 2px dashed #3b82f6;
            background-color: #eff6ff;
        }

        .drag-handle {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .dashboard-card:hover .drag-handle {
            opacity: 1;
        }

        #statusCards.drag-active {
            min-height: 200px;
        }

        .drop-zone {
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #3b82f6;
        }

        /* Weekly plan card specific styling */
        .dashboard-card[data-card-id="weekly-plan"] {
            min-height: auto;
            width: 100%;
        }

        /* Dashboard section styling */
        .dashboard-section {
            margin-bottom: 1.5rem;
        }

        /* Responsive adjustments for weekly plan */
        @media (max-width: 768px) {
            .dashboard-card[data-card-id="weekly-plan"] {
                grid-column: span 1;
            }
            
            #weeklyPlanPreview {
                gap: 0.5rem !important;
            }
            
            #weeklyPlanPreview > div {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
            }
        }

        /* Ensure all dashboard cards have consistent spacing and alignment */
        .dashboard-card {
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 220px; /* Fixed height for all cards */
        }

        .dashboard-card:last-child {
            margin-bottom: 0;
        }

        /* Status cards grid alignment */
        #statusCards {
            align-items: stretch; /* Make all cards same height in grid */
        }

        #statusCards .dashboard-card {
            height: 100%; /* Fill grid cell completely */
            min-height: 220px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-50">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="INR_Logo_v1.png" alt="INR Assistant Logo" class="h-12 w-12">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">注专 拽 </h1>
                        <p class="text-sm text-gray-600">INR Assistant</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <!-- Actions Dropdown -->
                    <div class="relative inline-block text-left">
                        <div>
                            <button type="button" onclick="toggleMenu('actions-menu')" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-semibold transition duration-200" id="actions-menu-button">
                                <i data-lucide="settings-2" class="w-4 h-4"></i>
                                <span>驻注转</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                    </button>
                        </div>
                        <div id="actions-menu" class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                            <div class="py-1" role="none">
                                <a href="#" onclick="exportData(); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><i data-lucide="download" class="w-4 h-4 text-gray-500"></i> 转</a>
                                <a href="#" onclick="document.getElementById('importFile').click(); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><i data-lucide="upload" class="w-4 h-4 text-gray-500"></i>砖专 转</a>
                                <a href="#" onclick="loadMockDataManually(); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><i data-lucide="database" class="w-4 h-4 text-gray-500"></i>转 </a>
                                <a href="#" onclick="resetCardOrder(); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem"><i data-lucide="layout-grid" class="w-4 h-4 text-gray-500"></i>驻住 住专 专住</a>
                            </div>
                        </div>
                                            </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

                    <!-- Font Scale Control -->
                    <div class="relative inline-block text-left">
                        <div>
                            <button type="button" onclick="toggleMenu('font-menu')" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-semibold transition duration-200" id="font-menu-button">
                                <i data-lucide="type" class="w-4 h-4"></i>
                                <span> 驻</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                            </button>
                        </div>
                        <div id="font-menu" class="hidden origin-top-right absolute right-0 mt-2 w-44 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                            <div class="py-1" role="none">
                                <a href="#" onclick="setFontScale('small'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                    <i data-lucide="minus" class="w-4 h-4 text-gray-500"></i>拽 (14px)
                                </a>
                                <a href="#" onclick="setFontScale('normal'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 bg-blue-50" role="menuitem">
                                    <i data-lucide="type" class="w-4 h-4 text-gray-500"></i>专 (16px)
                                </a>
                                <a href="#" onclick="setFontScale('large'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                    <i data-lucide="plus" class="w-4 h-4 text-gray-500"></i> (18px)
                                </a>
                                <a href="#" onclick="setFontScale('xl'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                    <i data-lucide="plus-circle" class="w-4 h-4 text-gray-500"></i>  (20px)
                                </a>
                                <a href="#" onclick="setFontScale('xxl'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                    <i data-lucide="maximize-2" class="w-4 h-4 text-gray-500"></i>注拽 (22px)
                                </a>
                            </div>
                        </div>
                    </div>

                                            <!-- Width Control -->
                        <div class="relative inline-block text-left">
                            <div>
                                <button type="button" onclick="toggleMenu('width-menu')" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-semibold transition duration-200" id="width-menu-button">
                                    <i data-lucide="monitor" class="w-4 h-4"></i>
                                    <span>砖 转爪</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                    </button>
                            </div>
                            <div id="width-menu" class="hidden origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                                <div class="py-1" role="none">
                                    <a href="#" onclick="setDashboardWidth('small'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="smartphone" class="w-4 h-4 text-gray-500"></i>爪专
                                    </a>
                                    <a href="#" onclick="setDashboardWidth('medium'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                        <i data-lucide="tablet" class="w-4 h-4 text-gray-500"></i>
                                    </a>
                                    <a href="#" onclick="setDashboardWidth('large'); closeAllMenus();" class="flex items-center gap-3 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 bg-blue-50" role="menuitem">
                                        <i data-lucide="monitor" class="w-4 h-4 text-gray-500"></i>专
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- User Menu Dropdown -->
                        <div class="relative inline-block text-left">
                            <div>
                                 <button type="button" onclick="toggleMenu('user-menu')" class="flex items-center gap-2" id="user-menu-button">
                                    <img id="userAvatar" class="h-9 w-9 rounded-full border-2 border-gray-200" src="INR_Logo_v1.png" alt="User avatar">
                                    <span id="userName" class="text-sm font-medium text-gray-800"></span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-600"></i>
                    </button>
                            </div>
                            <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                                <div class="py-1">
                                    <a href="admin.html" id="adminLink" class="hidden flex items-center gap-3 text-gray-700 px-4 py-2 text-sm hover:bg-gray-100">
                                        <i data-lucide="shield" class="w-4 h-4 text-gray-500"></i>
                                        <span>专 </span>
                                    </a>
                                    <a href="#" onclick="signOut()" class="flex items-center gap-3 text-gray-700 px-4 py-2 text-sm hover:bg-gray-100">
                                        <i data-lucide="log-out" class="w-4 h-4 text-gray-500"></i>
                                        <span>转转拽</span>
                                    </a>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex space-x-6 border-b border-gray-200">
            <button class="tab-button tab-active px-4 py-2 text-sm font-medium" onclick="switchTab('main')">
                <i data-lucide="activity" class="w-4 h-4 inline ml-2"></i>
                 INR
            </button>
            <button class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchTab('explanations')">
                <i data-lucide="book-open" class="w-4 h-4 inline ml-2"></i>
                住专 砖
            </button>
        </div>
    </div>

    <!-- Main Tab Content -->
    <div id="main-tab" class="tab-content active">
        <div id="mainContainer" class="dashboard-width-large mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 xl:grid-cols-4 lg:grid-cols-3 gap-8">
                <!-- Left Column - Input Forms -->
                <div class="xl:col-span-1 lg:col-span-1 space-y-6">
                    <!-- Data Input Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 fade-in" id="measurementInputCard">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="clipboard-plus" class="w-5 h-5 text-green-600"></i>
                            住驻转  砖
                        </h2>
                        <form id="dataForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">转专</label>
                                    <input type="date" id="measurementDate" required max="" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">注专 INR</label>
                                    <input type="number" id="inrValue" step="0.1" min="0.8" max="10" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="2.5">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">  (")</label>
                                <input type="number" id="dailyDose" step="0.5" min="0.5" max="20" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="5.0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">转专驻转 转</label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="antibiotics" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm">拽</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="painkillers" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm">砖  (NSAIDs)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="aspirin" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-sm">住驻专</span>
                                    </label>
                                </div>
                                <input type="text" id="otherMeds" maxlength="200" class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="转专驻转 住驻转 (注 200 转)...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">转住/注专转</label>
                                <textarea id="symptoms" rows="3" maxlength="500" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder=", 专转, 砖 转 (注 500 转)..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                住祝  砖 爪
                            </button>
                        </form>
                    </div>

                    <!-- Patient Info Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 fade-in" id="patientInfoCard">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                            驻专 驻
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">砖 驻</label>
                                <input type="text" id="patientName" value="" required maxlength="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="住 砖 驻">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1"></label>
                                    <input type="number" id="patientAge" min="18" max="120" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="65">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">砖拽 (拽")</label>
                                    <input type="number" id="patientWeight" min="30" max="300" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="70">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1"> 注 INR</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="targetMin" step="0.1" min="1.5" max="3.5" value="2.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <span class="self-center">-</span>
                                        <input type="number" id="targetMax" step="0.1" min="2.0" max="4.5" value="3.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Clinical Factors for Better Accuracy -->
                            <div class="border-t border-gray-200 pt-4 mt-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                    <i data-lucide="stethoscope" class="w-4 h-4 text-blue-600"></i>
                                    驻专 住驻 砖 拽 转专
                                </h3>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">注砖</label>
                                        <select id="smokingStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="never">祝 驻注  注砖</option>
                                            <option value="former-recent">驻住拽 注砖 (驻转 砖)</option>
                                            <option value="former-old">驻住拽 注砖 (转专 砖)</option>
                                            <option value="light">注砖 拽 (注 10 住专转 )</option>
                                            <option value="moderate">注砖  (10-20 住专转 )</option>
                                            <option value="heavy">注砖  (注 20 住专转 )</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1"></label>
                                        <select id="alcoholStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="none"> 砖转 </option>
                                            <option value="rare">注转 专拽转 (住驻专 驻注 砖)</option>
                                            <option value="social">专转 (住 砖转 砖注)</option>
                                            <option value="moderate"> (3-7 砖拽转 砖注)</option>
                                            <option value="heavy"> (转专 砖拽  )</option>
                                            <option value="binge">砖转 专转 (专 驻注 转)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">转  K</label>
                                        <select id="dietStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="consistent-low">拽注 - 注 专拽转 注</option>
                                            <option value="consistent-moderate">拽注 - 转 专拽转 转</option>
                                            <option value="consistent-high">拽注 - 专 专拽转 注</option>
                                            <option value="variable-mild">砖转 注 (转 住 )</option>
                                            <option value="variable-moderate">砖转 </option>
                                            <option value="variable-extreme">砖转  ( 砖  )</option>
                                            <option value="supplements">拽 转住驻  K</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">住转 拽</label>
                                        <select id="indication" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="afib">驻专驻专 驻专专</option>
                                            <option value="flutter">专驻专祝 驻专专</option>
                                            <option value="valve-mechanical">住转 转 </option>
                                            <option value="valve-bio">住转 </option>
                                            <option value="dvt">拽专砖 专 (DVT)</option>
                                            <option value="pe">转住祝 专转 (PE)</option>
                                            <option value="stroke">注转 砖抓</option>
                                            <option value="cardiomyopathy">拽专驻转</option>
                                            <option value="antiphospholipid">转住转 -驻住驻驻</option>
                                            <option value="other">专</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">驻拽爪转 </label>
                                        <select id="liverFunction" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="normal">转拽</option>
                                            <option value="mild">拽 拽</option>
                                            <option value="moderate">拽 转</option>
                                            <option value="severe">拽 专</option>
                                            <option value="cirrhosis">砖转 </option>
                                            <option value="hepatitis">拽转  驻注</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">驻拽爪转 转</label>
                                        <select id="kidneyFunction" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="normal">转拽</option>
                                            <option value="mild">拽 拽 (拽专 注 1.2)</option>
                                            <option value="moderate">拽 转 (拽专 1.5-3)</option>
                                            <option value="severe">拽 专 (拽专 注 3)</option>
                                            <option value="dialysis"></option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">拽 ( 注)</label>
                                        <select id="genetics" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="unknown"> 注</option>
                                            <option value="normal">拽 转拽</option>
                                            <option value="cyp2c9-slow">CYP2C9 </option>
                                            <option value="cyp2c9-fast">CYP2C9 专</option>
                                            <option value="vkorc1-sensitive">VKORC1 专砖</option>
                                            <option value="vkorc1-resistant">VKORC1 注</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">专转 驻注转</label>
                                        <select id="activityLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="sedentary">砖 专 </option>
                                            <option value="light">驻注转 拽</option>
                                            <option value="moderate">驻注转 转</option>
                                            <option value="active">驻注 </option>
                                            <option value="athlete">住驻专</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button onclick="savePatientInfo()" id="savePatientBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                <i data-lucide="save" class="w-4 h-4 inline ml-2"></i>
                                砖专 驻专 驻
                            </button>
                            <div id="patientSavedMsg" class="hidden bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                <div class="flex items-center justify-center gap-2 text-green-800">
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    <span class="font-semibold">驻 砖专 爪</span>
                                </div>
                                <p class="text-sm text-green-600 mt-1">转 注专  砖拽  注转</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Analysis & Results -->
                <div class="xl:col-span-3 lg:col-span-2 space-y-6" id="dashboardContainer">
                    <!-- Current Status Overview -->
                    <div class="dashboard-section">
                        <!-- Status Cards Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Current INR Card -->
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-blue-500 text-white p-2 rounded-lg">
                                            <i data-lucide="activity" class="w-5 h-5"></i>
                                        </div>
                                        <h3 class="text-sm font-semibold text-blue-900">INR </h3>
                                    </div>
                                    <div class="text-xs text-blue-600 bg-blue-200 px-2 py-1 rounded-full" id="inrTrend">--</div>
                                </div>
                                <div class="text-3xl font-bold text-blue-900 mb-1" id="currentINR">--</div>
                                <div class="text-sm text-blue-700" id="currentDate"> 转</div>
                                <div class="mt-3 h-1 bg-blue-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 transition-all duration-500" id="inrProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- Next Dose Card -->
                            <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-green-500 text-white p-2 rounded-lg">
                                            <i data-lucide="pill" class="w-5 h-5"></i>
                                </div>
                                        <h3 class="text-sm font-semibold text-green-900"> 专</h3>
                                    </div>
                                    <div class="text-xs text-green-600" id="doseConfidence">--</div>
                                </div>
                                <div class="text-3xl font-bold text-green-900 mb-1" id="tomorrowDose">--</div>
                                <div class="text-sm text-green-700" id="tomorrowDate">--</div>
                                <div class="mt-3 flex items-center gap-2">
                                    <i data-lucide="clock" class="w-4 h-4 text-green-600"></i>
                                    <span class="text-xs text-green-600" id="nextTestDate">拽 : --</span>
                                </div>
                            </div>
                            
                            <!-- Target Range Card -->
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-purple-500 text-white p-2 rounded-lg">
                                            <i data-lucide="target" class="w-5 h-5"></i>
                                </div>
                                        <h3 class="text-sm font-semibold text-purple-900"> 注</h3>
                                    </div>
                                    <div class="text-xs text-purple-600" id="targetStatus">--</div>
                                </div>
                                <div class="text-3xl font-bold text-purple-900 mb-1">
                                    <span id="displayTargetMin">2.0</span>-<span id="displayTargetMax">3.0</span>
                                </div>
                                <div class="text-sm text-purple-700">注 驻</div>
                                <div class="mt-3 flex items-center gap-2">
                                    <div class="flex-1 bg-purple-200 rounded-full h-2">
                                        <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" id="targetRangeIndicator" style="width: 50%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Statistics Card -->
                            <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-orange-500 text-white p-2 rounded-lg">
                                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                                </div>
                                        <h3 class="text-sm font-semibold text-orange-900">住住拽</h3>
                                </div>
                                    <div class="text-xs text-orange-600" id="stabilityScore">--</div>
                                </div>
                                <div class="text-3xl font-bold text-orange-900 mb-1" id="inRangePercent">--%</div>
                                <div class="text-sm text-orange-700"> 注</div>
                                <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                                    <div class="text-center">
                                        <div class="font-semibold text-orange-800" id="totalMeasurements">0</div>
                                        <div class="text-orange-600">转</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-orange-800" id="daysSinceFirst">0</div>
                                        <div class="text-orange-600"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Smart Insights Panel -->
                        <div id="insightsPanel" class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-6 mb-8 shadow-lg relative overflow-hidden">
                            <!-- Subtle logo watermark -->
                            <div class="absolute top-4 left-4 opacity-5">
                                <img src="INR_Logo_v1.png" alt="" class="h-16 w-16">
                            </div>
                            <div class="flex items-center gap-3 mb-4 relative z-10">
                                <div class="bg-indigo-500 text-white p-2 rounded-lg">
                                    <i data-lucide="lightbulb" class="w-5 h-5"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-indigo-900">转转 转</h3>
                                <div class="flex-1"></div>
                                <button onclick="toggleInsights()" class="text-indigo-600 hover:text-indigo-800">
                                    <i data-lucide="chevron-up" class="w-5 h-5" id="insightsToggle"></i>
                                </button>
                            </div>
                            <div id="insightsContent" class="space-y-3 relative z-10">
                                <!-- Insights will be populated here -->
                            </div>
                        </div>

                        <!-- Weekly Dose Plan Card - Full Width -->
                        <div class="dashboard-card bg-gradient-to-l from-blue-50 to-indigo-100 rounded-xl shadow-lg p-6 fade-in cursor-move border-r-4 border-blue-500" draggable="true" data-card-id="weekly-plan">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center justify-center gap-2">
                                         转转  砖注转
                                    </h3>
                                    <div id="weeklyPlanPreview" class="flex flex-wrap justify-center gap-3">
                                        <span class="text-gray-500">专 砖</span>
                                    </div>
                                </div>
                                <div class="drag-handle text-gray-400 text-sm ml-6">
                                    <i data-lucide="grip-vertical" class="w-5 h-5 mx-auto"></i>
                                    <div class="text-center mt-1">专专</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 fade-in" id="recommendationsCard" style="display: none;">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="brain" class="w-5 h-5 text-purple-600"></i>
                            爪转 转拽转 
                        </h2>
                        <div id="recommendationsContent">
                            <!-- Recommendations will be populated here -->
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <button onclick="askChatGPT()" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-3 border border-gray-600 shadow-lg">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 6.0462 6.0462 0 0 0 3.9977-2.9 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z"/>
                                </svg>
                                <span class="font-medium">Ask ChatGPT</span>
                            </button>
                        </div>
                    </div>

                    <!-- Trend Analysis Chart -->
                    <div class="dashboard-card bg-white rounded-xl shadow-lg p-6 fade-in cursor-move" draggable="true" data-card-id="chart">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                                转 转 INR
                            </h2>
                            <div class="drag-handle text-gray-400 text-sm">
                                <i data-lucide="grip-vertical" class="w-5 h-5 mx-auto"></i>
                                <div class="text-center mt-1 text-xs">专专</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="inrChart"></canvas>
                        </div>
                    </div>

                    <!-- Data History Table -->
                    <div class="dashboard-card bg-white rounded-xl shadow-lg p-6 fade-in cursor-move" draggable="true" data-card-id="history">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold flex items-center gap-2">
                                <i data-lucide="table" class="w-5 h-5 text-orange-600"></i>
                                住专转 转
                            </h2>
                            <div class="flex items-center gap-3">
                                <button onclick="deleteAllHistory()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors" title="拽 转  住专">
                                    <i data-lucide="trash" class="w-4 h-4"></i>
                                    拽 
                                </button>
                                <div class="drag-handle text-gray-400 text-sm">
                                    <i data-lucide="grip-vertical" class="w-5 h-5 mx-auto"></i>
                                    <div class="text-center mt-1 text-xs">专专</div>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-right font-semibold">转专</th>
                                        <th class="px-4 py-3 text-right font-semibold">INR</th>
                                        <th class="px-4 py-3 text-right font-semibold"> (")</th>
                                        <th class="px-4 py-3 text-right font-semibold">转专驻转 转</th>
                                        <th class="px-4 py-3 text-right font-semibold">爪</th>
                                        <th class="px-4 py-3 text-right font-semibold">驻注转</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTable">
                                    <tr id="inr-loader-row">
                                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                            <div class="flex justify-center items-center gap-2">
                                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <span>注 住专转 转...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanations Tab Content -->
    <div id="explanations-tab" class="tab-content">
        <div id="explanationsContainer" class="dashboard-width-large mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                    <i data-lucide="calculator" class="w-8 h-8 text-blue-600"></i>
                    住专 砖 - 注专 拽 
                </h1>

                <!-- Sub-navigation for explanations -->
                <div class="flex flex-wrap gap-2 mb-8 border-b border-gray-200 pb-4">
                    <button onclick="switchExplanationTab('basics')" id="exp-basics-btn" class="explanation-tab-btn active px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition duration-200 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        住住
                    </button>
                    <button onclick="switchExplanationTab('medications')" id="exp-medications-btn" class="explanation-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200 flex items-center gap-2">
                        <i data-lucide="pill" class="w-4 h-4"></i>
                        转专驻转 专拽爪转
                    </button>
                    <button onclick="switchExplanationTab('dosing')" id="exp-dosing-btn" class="explanation-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                         
                    </button>
                    <button onclick="switchExplanationTab('research')" id="exp-research-btn" class="explanation-tab-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200 flex items-center gap-2">
                        <i data-lucide="book-open" class="w-4 h-4"></i>
                        转 拽专
                    </button>
                </div>

                <!-- Basics Sub-tab -->
                <div id="exp-basics-content" class="explanation-content">
                    <div class="space-y-8">
                    <!-- Understanding Your Stability Score -->
                    <div class="border-r-4 border-blue-500 pr-6">
                        <h2 class="text-2xl font-semibold text-blue-800 mb-4 flex items-center gap-2">
                            <i data-lucide="target" class="w-6 h-6"></i>
                              爪 爪转?
                        </h2>
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <p class="text-blue-800 font-semibold">爪 专    -INR 砖   </p>
                        </div>
                        <div class="space-y-3 text-gray-700">
                            <p><strong>  砖?</strong> 驻砖  - 注专转 住驻专转  拽转   砖专驻 拽注 (专  2.0-3.0)</p>
                            
                            <p><strong> 爪 专:</strong></p>
                            <div class="space-y-2">
                                <div class="bg-green-50 p-3 rounded-lg border-r-4 border-green-400">
                                    <span class="text-green-700 font-semibold">70% 注 - 注! </span>
                                    <p class="text-sm text-green-600 mt-1">专  转  .  !</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border-r-4 border-blue-400">
                                    <span class="text-blue-700 font-semibold">50-69% -   </span>
                                    <p class="text-sm text-blue-600 mt-1">专   , 砖 拽 砖驻专 拽</p>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded-lg border-r-4 border-yellow-400">
                                    <span class="text-yellow-700 font-semibold">30-49% - 住专 锔</span>
                                    <p class="text-sm text-yellow-600 mt-1">爪  .  砖驻专 注 注专转 </p>
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg border-r-4 border-red-400">
                                    <span class="text-red-700 font-semibold">转转 -30% - 爪专 砖驻专 </span>
                                    <p class="text-sm text-red-600 mt-1">拽爪转 转转 专爪. 注专转 转注专  砖转驻专!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- How the Smart System Works -->
                    <div class="border-r-4 border-green-500 pr-6">
                        <h2 class="text-2xl font-semibold text-green-800 mb-4 flex items-center gap-2">
                            <i data-lucide="heart" class="w-6 h-6"></i>
                             注专转  注转?
                        </h2>
                        <div class="bg-green-50 p-4 rounded-lg mb-4">
                            <p class="text-green-800 font-semibold">注专转 砖转 3 砖转 砖 砖转  转转  转   拽</p>
                        </div>
                        
                        <div class="space-y-4 text-gray-700">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2">┖ 砖 专驻转 专</h3>
                                <p class="mb-2">  砖专驻 注砖 - 住转 注 -INR 砖 转 转 :</p>
                                <ul class="mr-6 space-y-1">
                                    <li>  -INR   - 注 转 </li>
                                    <li>  -INR   - 专 转 </li>
                                    <li>  转 专 -70 - 专  爪专 拽爪转 驻转 转专驻</li>
                                    <li>  转 专  砖 -   砖转 转</li>
                                </ul>
                            </div>

                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-purple-800 mb-2">К 砖 转</h3>
                                <p class="mb-2">砖 砖  专转 拽   砖:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> 砖 砖 砖爪专 转 转专驻 专 (爪专 转专)</li>
                                    <li> 砖 砖 砖爪专 转  (爪专 驻转)</li>
                                    <li> 注专转 转砖转  驻  砖拽 砖</li>
                                    <li>  转砖转 转专驻转 专转 砖转 拽</li>
                                </ul>
                            </div>

                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-indigo-800 mb-2"> 砖  ( 转转)</h3>
                                <p class="mb-2">砖   砖拽专 转 专 :</p>
                                <ul class="mr-6 space-y-1">
                                    <li> 住转 注 3 拽转 专转 砖</li>
                                    <li> 专  砖  (注? 专? 爪?)</li>
                                    <li>  砖砖 转专 拽转,   转专 </li>
                                    <li> 转砖  驻专 拽 砖 砖</li>
                                </ul>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-gray-800 mb-2">   注 ?</h3>
                                <ul class="mr-6 space-y-1">
                                    <li> 注专转  转专 -28,000 驻  注</li>
                                    <li> 砖 砖砖转砖 注专转 转 砖专   转专 </li>
                                    <li> 驻转 住 砖   拽专砖</li>
                                    <li>  转 驻 砖 拽 </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Medications Sub-tab -->
                <div id="exp-medications-content" class="explanation-content hidden">
                    <div class="space-y-8">
                        <!-- Important Drug Interactions -->
                        <div class="border-r-4 border-red-500 pr-6">
                        <h2 class="text-2xl font-semibold text-red-800 mb-4 flex items-center gap-2">
                            <i data-lucide="pill" class="w-6 h-6"></i>
                            转专驻转 砖砖驻注转 注 拽
                        </h2>
                        <div class="space-y-4 text-gray-700">
                            <div class="bg-red-50 p-4 rounded-lg border-r-4 border-red-400">
                                <h3 class="font-semibold text-red-800 mb-2"> 拽</h3>
                                <p class="mb-2"><strong> 拽专:</strong> 拽 专转 拽  砖注专 祝 转 注 拽</p>
                                <p><strong>转爪:</strong> 拽 驻注 拽 转专  -INR 注   转 </p>
                                <p class="text-red-700 font-semibold mt-2">  注砖转: 转 专驻  砖转 拽</p>
                            </div>
                            
                            <div class="bg-orange-50 p-4 rounded-lg border-r-4 border-orange-400">
                                <h3 class="font-semibold text-orange-800 mb-2"> 砖  (驻专驻, 拽驻拽)</h3>
                                <p class="mb-2"><strong> 拽专:</strong>  拽  砖  专 住 </p>
                                <p><strong>转爪:</strong> 1+1=3! 住 驻 转 专 转专 </p>
                                <p class="text-orange-700 font-semibold mt-2">  注砖转: 砖转砖 驻专爪 拽.  专 转专 </p>
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg border-r-4 border-yellow-400">
                                <h3 class="font-semibold text-yellow-800 mb-2">猸 住驻专</h3>
                                <p class="mb-2"><strong> 拽专:</strong>  住驻专  ,  拽</p>
                                <p><strong>转爪:</strong>   驻  住   </p>
                                <p class="text-yellow-700 font-semibold mt-2">  注砖转: 专拽  专驻 专 驻专砖! 爪专 注拽 爪</p>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg border-r-4 border-blue-400">
                                <h3 class="font-semibold text-blue-800 mb-2">斤   砖驻注!</h3>
                                <p class="mb-2"><strong>专拽转 注:</strong> 专, 专拽, 转专 -   K 砖驻转 转 拽</p>
                                <p class="text-blue-700 font-semibold">  转专 注 专拽转! 驻砖  转 拽注  砖注</p>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Dosing Sub-tab -->
                <div id="exp-dosing-content" class="explanation-content hidden">
                    <div class="space-y-8">
                        <!-- Trend Analysis -->
                        <div class="border-r-4 border-purple-500 pr-6">
                        <h2 class="text-2xl font-semibold text-purple-800 mb-4 flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-6 h-6"></i>
                            转 转
                        </h2>
                        <div class="space-y-3 text-gray-700">
                            <p><strong>砖:</strong> 砖转 砖砖 转 专转  转</p>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="font-semibold text-purple-800 mb-2">住 转:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> <strong>转 注:</strong> 砖砖 注专 注 专爪祝 - 砖拽 驻转 专转转</li>
                                    <li> <strong>转 专:</strong> 砖砖 注专 专 专爪祝 - 砖拽  专转转</li>
                                    <li> <strong> 爪:</strong>   专专 - 砖  </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Dosing -->
                    <div class="border-r-4 border-indigo-500 pr-6">
                        <h2 class="text-2xl font-semibold text-indigo-800 mb-4 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-6 h-6"></i>
                            转  砖注
                        </h2>
                        <div class="space-y-3 text-gray-700">
                            <p><strong>注拽专 转:</strong> 爪专转  砖转 砖驻专 爪转</p>
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <p class="font-semibold text-indigo-800 mb-2">砖转 砖:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> <strong> 住住:</strong> 注   抓 -0.5 拽专</li>
                                    <li> <strong>专爪:</strong> 驻转 砖 0.5 "    注 2.5 "</li>
                                    <li> <strong>专:</strong> 爪专转 驻专驻  爪 转专 砖专  拽注</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- When to Check Again -->
                    <div class="border-r-4 border-teal-500 pr-6">
                        <h2 class="text-2xl font-semibold text-teal-800 mb-4 flex items-center gap-2">
                            <i data-lucide="calendar-check" class="w-6 h-6"></i>
                            转 注砖转 拽 ?
                        </h2>
                        <div class="space-y-3 text-gray-700">
                            <div class="bg-teal-50 p-4 rounded-lg">
                                <p class="font-semibold text-teal-800 mb-3">注专转 转  拽 转 拽, 转 爪:</p>
                                
                                <div class="space-y-3">
                                    <div class="bg-red-50 p-3 rounded-lg border-r-4 border-red-500">
                                        <p class="font-semibold text-red-700">  -INR 注 5 - 祝 !</p>
                                        <p class="text-red-600 text-sm mt-1">拽 注 专.  转!</p>
                                    </div>
                                    
                                    <div class="bg-orange-50 p-3 rounded-lg border-r-4 border-orange-500">
                                        <p class="font-semibold text-orange-700">锔  -INR 注 4 - 祝</p>
                                        <p class="text-orange-600 text-sm mt-1">拽 转 </p>
                                    </div>
                                    
                                    <div class="bg-yellow-50 p-3 rounded-lg border-r-4 border-yellow-500">
                                        <p class="font-semibold text-yellow-700">  砖  住专</p>
                                        <p class="text-yellow-600 text-sm mt-1">拽 转 4 </p>
                                    </div>
                                    
                                    <div class="bg-green-50 p-3 rounded-lg border-r-4 border-green-500">
                                        <p class="font-semibold text-green-700">   住专</p>
                                        <p class="text-green-600 text-sm mt-1">拽 注 砖注,   </p>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-white rounded-lg border">
                                    <p class="text-teal-700 font-semibold text-sm">
                                         驻  转专: 注砖 拽 转  砖注 转 砖注  驻注
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Research Sub-tab -->
                <div id="exp-research-content" class="explanation-content hidden">
                    <div class="space-y-8">
                        <!-- Data Backup and Safety -->
                        <div class="border-r-4 border-cyan-500 pr-6">
                        <h2 class="text-2xl font-semibold text-cyan-800 mb-4 flex items-center gap-2">
                            <i data-lucide="hard-drive" class="w-6 h-6"></i>
                             砖专转 转
                        </h2>
                        <div class="space-y-3 text-gray-700">
                            <div class="bg-cyan-50 p-4 rounded-lg">
                                <p class="font-semibold text-cyan-800 mb-2">驻 转 砖专:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> <strong>转:</strong> 驻驻 (LocalStorage) - 砖专  驻注 砖住专 转 祝</li>
                                    <li> <strong> :</strong> 抓 注 " 转" 爪专转 拽抓 砖</li>
                                    <li> <strong> :</strong> 注专转 转爪注   5 转</li>
                                </ul>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="font-semibold text-green-800 mb-2"> 砖专 转:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> 抓 注 "砖专 转" 专 拽抓 </li>
                                    <li> 注专转 转爪 驻专  驻 砖专</li>
                                    <li> 转 砖专  砖 砖</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <p class="font-semibold text-yellow-800 mb-2">爪转 转:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> 爪专  转 砖注  专  拽专 专驻</li>
                                    <li> 砖专 拽爪  拽  (转拽 转,  爪)</li>
                                    <li>  砖 砖专 驻 拽 驻驻</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Where This Knowledge Comes From -->
                    <div class="border-r-4 border-amber-500 pr-6">
                        <h2 class="text-2xl font-semibold text-amber-800 mb-4 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-6 h-6"></i>
                            驻  转 ?
                        </h2>
                        <div class="space-y-4 text-gray-700">
                            <div class="bg-amber-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-amber-800 mb-2"> 拽专  注:</h3>
                                <ul class="mr-6 space-y-2">
                                    <li> <strong>拽专  :</strong>  -28,000 驻  砖转</li>
                                    <li> <strong>拽专 拽:</strong>    砖驻注 注 转专驻</li>
                                    <li> <strong>砖 :</strong> 拽  转  爪 驻住</li>
                                    <li> <strong>驻专拽 砖 专驻:</strong>  专驻  注砖  专抓</li>
                                </ul>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-green-800 mb-2">   转 注?</h3>
                                <ul class="mr-6 space-y-2">
                                    <li> <strong>转专   :</strong> 砖 砖砖转砖  砖专  6-7% 转专 </li>
                                    <li> <strong>驻转 注转:</strong> 10-11% 驻转 砖爪,  拽专砖</li>
                                    <li> <strong>转 砖转:</strong>   拽 拽  砖转 </li>
                                </ul>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2"> 驻 砖转砖 ?</h3>
                                <p class="mb-2">注专转  砖砖转 专 转  转拽  注:</p>
                                <ul class="mr-6 space-y-1">
                                    <li> 转  专拽, 专驻, 拽</li>
                                    <li> 专驻转  拽</li>
                                    <li> 专 专驻 转拽 砖专</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Important Note -->
                    <div class="bg-blue-50 border border-blue-300 rounded-lg p-6">
                        <h3 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                            <i data-lucide="heart-handshake" class="w-5 h-5 text-blue-600"></i>
                            砖 砖转注! 
                        </h3>
                        <div class="text-blue-700 leading-relaxed space-y-3">
                            <p>
                                <strong>注专转 转  </strong> -   注砖专转 驻 驻  注 
                                 注专  砖专   转专  注 驻转 住.
                            </p>
                            <p>
                                <strong> 专:</strong>  注专 注,  专驻 砖 注  砖! 
                                转 转专  转 爪转 驻 砖转 砖 砖. 
                            </p>
                            <p>
                                   拽专 , 砖 专 砖专拽 专驻 砖 注 注 - 
                                转专驻转 砖转 拽, 注转 专转转 砖,  砖专.
                            </p>
                            <p class="font-semibold text-blue-800">
                                 砖转砖 注专转  注专 ,  转 转 注 专驻!
                            </p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let inrData = [];
        let patientInfo = {};
        let inrChart = null;
        let currentUser = null;
        let editingIndex = -1; // Track which record is being edited
        const ADMIN_EMAIL = "OhaviNiv@gmail.com";

        // --- Menu Management ---
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId);
            const isHidden = menu.classList.contains('hidden');
            closeAllMenus();
            if (isHidden) {
                menu.classList.remove('hidden');
            }
        }

        function closeAllMenus() {
            document.getElementById('actions-menu').classList.add('hidden');
            document.getElementById('user-menu').classList.add('hidden');
            document.getElementById('font-menu').classList.add('hidden');
            document.getElementById('width-menu').classList.add('hidden');
        }

        // Close menus if clicking outside
        window.addEventListener('click', function(e) {
            if (!document.getElementById('actions-menu-button').contains(e.target) && !document.getElementById('actions-menu').contains(e.target) &&
                !document.getElementById('user-menu-button').contains(e.target) && !document.getElementById('user-menu').contains(e.target) &&
                !document.getElementById('font-menu-button').contains(e.target) && !document.getElementById('font-menu').contains(e.target) &&
                !document.getElementById('width-menu-button').contains(e.target) && !document.getElementById('width-menu').contains(e.target)) {
                closeAllMenus();
            }
        });

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab button
            event.target.classList.add('tab-active');
            event.target.classList.remove('text-gray-500', 'hover:text-gray-700');
            
            // Reinitialize icons for the new tab
            lucide.createIcons();
        }

        // Switch between explanation sub-tabs
        function switchExplanationTab(tabName) {
            // Hide all explanation contents
            document.querySelectorAll('.explanation-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all explanation tab buttons
            document.querySelectorAll('.explanation-tab-btn').forEach(button => {
                button.classList.remove('bg-blue-100', 'text-blue-700', 'active');
                button.classList.add('bg-gray-100', 'text-gray-700');
            });

            // Show selected explanation content
            document.getElementById('exp-' + tabName + '-content').classList.remove('hidden');

            // Add active class to selected explanation tab button
            const activeBtn = document.getElementById('exp-' + tabName + '-btn');
            activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
            activeBtn.classList.add('bg-blue-100', 'text-blue-700', 'active');
            
            // Reinitialize icons
            lucide.createIcons();
        }

        // Save patient info
        function savePatientInfo() {
            const name = document.getElementById('patientName').value.trim();
            const age = parseFloat(document.getElementById('patientAge').value);
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const targetMin = parseFloat(document.getElementById('targetMin').value);
            const targetMax = parseFloat(document.getElementById('targetMax').value);

            // Basic validation
            if (!name) {
                showNotification('砖 驻  砖 ', 'error');
                return;
            }

            if (name.length > 50) {
                showNotification('砖 驻 专  (注 50 转)', 'error');
                return;
            }

            // Validate patient info
            const validation = validatePatientInfo(age, weight, targetMin, targetMax);
            
            if (!showValidationResults(validation.errors, validation.warnings)) {
                return;
            }
            
            patientInfo = {
                name: name,
                age: age || '',
                weight: weight || '',
                targetMin: targetMin || 2.0,
                targetMax: targetMax || 3.0,
                smokingStatus: document.getElementById('smokingStatus').value,
                alcoholStatus: document.getElementById('alcoholStatus').value,
                dietStatus: document.getElementById('dietStatus').value,
                indication: document.getElementById('indication').value,
                liverFunction: document.getElementById('liverFunction').value,
                kidneyFunction: document.getElementById('kidneyFunction').value,
                genetics: document.getElementById('genetics').value,
                activityLevel: document.getElementById('activityLevel').value,
                saved: true
            };
            
            const db = firebase.firestore();
            db.collection('users').doc(currentUser.uid).set({
                patientInfo: patientInfo
            }, { merge: true }).then(() => {
            showNotification('驻专 驻 砖专 爪!', 'success');
            setPatientEditMode();
            updateDisplay();
            }).catch(error => {
                console.error("Error saving patient info:", error);
                showNotification('砖 砖专转 驻专 驻', 'error');
            });
        }

        // Set patient to edit mode after saving
        function setPatientEditMode() {
            document.getElementById('patientName').readOnly = true;
            document.getElementById('patientName').classList.add('bg-gray-100');
            document.getElementById('savePatientBtn').classList.add('hidden');
            document.getElementById('patientSavedMsg').classList.remove('hidden');
            
            // Swap card positions - measurement card goes first for convenience
            const patientCard = document.getElementById('patientInfoCard');
            const measurementCard = document.getElementById('measurementInputCard');
            const parent = patientCard.parentNode;
            
            // Move patient card after measurement card (they're already in correct order)
            // Just add visual indication that patient is saved
            patientCard.classList.add('border-l-4', 'border-green-500');
            
            lucide.createIcons();
        }

        // Load patient info
        function loadPatientInfo() {
            const db = firebase.firestore();
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists && doc.data().patientInfo) {
                    patientInfo = doc.data().patientInfo;
                document.getElementById('patientName').value = patientInfo.name || '';
                document.getElementById('patientAge').value = patientInfo.age || '';
                document.getElementById('patientWeight').value = patientInfo.weight || '';
                document.getElementById('targetMin').value = patientInfo.targetMin || 2.0;
                document.getElementById('targetMax').value = patientInfo.targetMax || 3.0;
                
                // Load additional clinical factors
                if (document.getElementById('smokingStatus')) {
                    document.getElementById('smokingStatus').value = patientInfo.smokingStatus || 'never';
                }
                if (document.getElementById('alcoholStatus')) {
                    document.getElementById('alcoholStatus').value = patientInfo.alcoholStatus || 'none';
                }
                if (document.getElementById('dietStatus')) {
                    document.getElementById('dietStatus').value = patientInfo.dietStatus || 'consistent-moderate';
                }
                if (document.getElementById('indication')) {
                    document.getElementById('indication').value = patientInfo.indication || 'afib';
                }
                if (document.getElementById('liverFunction')) {
                    document.getElementById('liverFunction').value = patientInfo.liverFunction || 'normal';
                }
                if (document.getElementById('kidneyFunction')) {
                    document.getElementById('kidneyFunction').value = patientInfo.kidneyFunction || 'normal';
                }
                if (document.getElementById('genetics')) {
                    document.getElementById('genetics').value = patientInfo.genetics || 'unknown';
                }
                if (document.getElementById('activityLevel')) {
                    document.getElementById('activityLevel').value = patientInfo.activityLevel || 'light';
                }
                
                // Backward compatibility with old checkbox format
                if (patientInfo.liverIssues && !patientInfo.liverFunction) {
                    document.getElementById('liverFunction').value = 'mild';
                }
                if (patientInfo.kidneyIssues && !patientInfo.kidneyFunction) {
                    document.getElementById('kidneyFunction').value = 'mild';
                }
                
                // If patient was already saved, switch to edit mode
                if (patientInfo.saved) {
                    setPatientEditMode();
                }
            } else {
                    // Set defaults for new user
                    document.getElementById('patientName').value = currentUser.displayName || '';
                document.getElementById('targetMin').value = 2.0;
                document.getElementById('targetMax').value = 3.0;
                    // Store new user in Firestore
                    db.collection('users').doc(currentUser.uid).set({
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
            }).catch(error => {
                console.error("Error loading patient info:", error);
            });
        }

        // Load data from firestore
        function loadData() {
            showLoading('dataTable');
            const db = firebase.firestore();
            db.collection('inrData').doc(currentUser.uid).get().then(doc => {
                if (doc.exists && doc.data().measurements) {
                    inrData = doc.data().measurements;
                updateDisplay();
                } else {
                     // If no data exists, offer to load mock data
                    if (inrData.length === 0) {
                        setTimeout(() => {
                            const shouldLoadMock = confirm(
                                ` 专  注专 拽 !\n\n` +
                                ` 转专爪 住祝 转   专转  注专转 注转?\n\n` +
                                `转  8 转  注 爪 砖.`
                            );
                            
                            if (shouldLoadMock) {
                                addMockData();
                            }
                        }, 1500);
                    }
                }
            // Set today's date as default and max date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('measurementDate').value = today;
            document.getElementById('measurementDate').max = today;
                hideLoading('dataTable');
            }).catch(error => {
                console.error("Error loading INR data:", error);
                hideLoading('dataTable');
            });
        }

        // Loading indicator functions
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const loadingHtml = `
                    <tr>
                        <td colspan="6" class="text-center py-12">
                            <div class="flex items-center justify-center gap-2">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                <span class="text-gray-600">注 转...</span>
                            </div>
                        </td>
                    </tr>
                `;
                container.innerHTML = loadingHtml;
            }
        }

        function hideLoading(containerId) {
            // Loading will be replaced by actual content when updateDisplay() is called
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        // Save data to firestore
        function saveData() {
            const db = firebase.firestore();
            db.collection('inrData').doc(currentUser.uid).set({
                measurements: inrData
            }).catch(error => {
                console.error("Error saving INR data:", error);
                showNotification('砖 砖专转 转 ', 'error');
            });
        }

        // Form submission handler
        function handleFormSubmit(event) {
            event.preventDefault();
            
            const inrValue = parseFloat(document.getElementById('inrValue').value);
            const date = document.getElementById('measurementDate').value;
            const dose = parseFloat(document.getElementById('dailyDose').value);
            const notes = document.getElementById('symptoms').value.trim();
            
            if (!date || isNaN(inrValue) || isNaN(dose)) {
                showNotification('  转  砖转 专砖', 'error');
                return;
            }
            
            const measurement = {
                date: date,
                inr: inrValue,
                dose: dose,
                antibiotics: document.getElementById('antibiotics').checked,
                painkillers: document.getElementById('painkillers').checked,
                aspirin: document.getElementById('aspirin').checked,
                otherMeds: document.getElementById('otherMeds').value.trim(),
                symptoms: notes,
                timestamp: new Date().toISOString()
            };
            
            if (editingIndex >= 0) {
                // Update existing record
                inrData[editingIndex] = measurement;
                showNotification(' 注 爪!', 'success');
                cancelEdit();
            } else {
                // Add new record
                inrData.push(measurement);
                showNotification(' 住驻 爪!', 'success');
            }
            
            inrData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            updateDisplay();
            document.getElementById('inrForm').reset();
            
            // Reset date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('measurementDate').value = today;
        }

        // Edit an existing record
        function editRecord(index) {
            const record = inrData[index];
            editingIndex = index;
            
            // Populate form with existing data
            document.getElementById('measurementDate').value = record.date;
            document.getElementById('inrValue').value = record.inr;
            document.getElementById('dailyDose').value = record.dose;
            document.getElementById('antibiotics').checked = record.antibiotics || false;
            document.getElementById('painkillers').checked = record.painkillers || false;
            document.getElementById('aspirin').checked = record.aspirin || false;
            document.getElementById('otherMeds').value = record.otherMeds || '';
            document.getElementById('symptoms').value = record.symptoms || '';
            
            // Update form appearance
            const submitBtn = document.querySelector('#inrForm button[type="submit"]');
            const formTitle = document.querySelector('#measurement-form h2');
            
            submitBtn.textContent = '注 ';
            submitBtn.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200';
            formTitle.textContent = '注专转 ';
            
            // Show cancel button
            let cancelBtn = document.getElementById('cancelEditBtn');
            if (!cancelBtn) {
                cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.type = 'button';
                cancelBtn.className = 'w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200';
                cancelBtn.textContent = ' 注专';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
            }
            
            // Scroll to form
            document.getElementById('measurement-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel editing
        function cancelEdit() {
            editingIndex = -1;
            
            // Reset form appearance
            const submitBtn = document.querySelector('#inrForm button[type="submit"]');
            const formTitle = document.querySelector('#measurement-form h2');
            
            submitBtn.textContent = '住祝 ';
            submitBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200';
            formTitle.textContent = '住驻转  砖';
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
            
            // Reset form
            document.getElementById('inrForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('measurementDate').value = today;
        }

        // Comprehensive input validation
        function validateInputs(date, inr, dose, otherMeds, symptoms) {
            const errors = [];
            const warnings = [];

            // Date validation
            if (!date) {
                errors.push('转专  砖 ');
            } else {
                const inputDate = new Date(date);
                const today = new Date();
                const twoYearsAgo = new Date();
                twoYearsAgo.setFullYear(today.getFullYear() - 2);
                
                if (inputDate > today) {
                    errors.push(' 转  转专 注转');
                }
                if (inputDate < twoYearsAgo) {
                    warnings.push('转专 砖  (注 砖转) -   ?');
                }
            }

            // INR validation
            if (isNaN(inr) || inr <= 0) {
                errors.push('注专 INR  转 住驻专 ');
            } else {
                if (inr < 0.8) {
                    errors.push('注专 INR   (转转 -0.8) - 拽 转 注专');
                } else if (inr > 10) {
                    errors.push('注专 INR 住 (注 10) - 驻 转 专驻!');
                } else if (inr < 1.0) {
                    warnings.push('注专 INR   -   ?');
                } else if (inr > 6.0) {
                    warnings.push('注专 INR   -   ?');
                }
            }

            // Dose validation
            if (isNaN(dose) || dose <= 0) {
                errors.push('  转 住驻专 ');
            } else {
                if (dose < 0.5) {
                    errors.push('   (转转 -0.5 ")');
                } else if (dose > 20) {
                    errors.push('   (注 20 ") - 拽 转 注专');
                } else if (dose > 15) {
                    warnings.push('  (注 15 ") -   ?');
                } else if (dose % 0.5 !== 0) {
                    warnings.push(' 专  拽驻爪转 砖 0.5 "');
                }
            }

            // Text fields validation
            if (otherMeds && otherMeds.length > 200) {
                errors.push('砖 "转专驻转 住驻转" 专  (注 200 转)');
            }
            
            if (symptoms && symptoms.length > 500) {
                errors.push('砖 "转住" 专  (注 500 转)');
            }

            return { errors, warnings };
        }

        // Validate patient info
        function validatePatientInfo(age, weight, targetMin, targetMax) {
            const errors = [];
            const warnings = [];

            // Age validation
            if (age && (isNaN(age) || age < 18 || age > 120)) {
                errors.push('  转  18-120');
            } else if (age && (age < 30 || age > 100)) {
                warnings.push(' 专 -  注专 ?');
            }

            // Weight validation
            if (weight && (isNaN(weight) || weight < 30 || weight > 300)) {
                errors.push('砖拽  转  30-300 拽"');
            } else if (weight && (weight < 40 || weight > 150)) {
                warnings.push('砖拽 专 -  注专 ?');
            }

            // Target INR validation
            if (targetMin && (isNaN(targetMin) || targetMin < 1.5 || targetMin > 3.5)) {
                errors.push('注 INR   转  1.5-3.5');
            }
            
            if (targetMax && (isNaN(targetMax) || targetMax < 2.0 || targetMax > 4.5)) {
                errors.push('注 INR 拽住  转  2.0-4.5');
            }

            if (targetMin && targetMax && targetMin >= targetMax) {
                errors.push('注 拽住  转  ');
            }

            if (targetMin && targetMax) {
                const range = targetMax - targetMin;
                if (range < 0.3) {
                    warnings.push(' 注 爪专  - 专  驻转 0.5 转');
                } else if (range > 1.5) {
                    warnings.push(' 注 专  - 专  注 1.0 转');
                }
            }

            return { errors, warnings };
        }

        // Show validation results
        function showValidationResults(errors, warnings) {
            if (errors.length > 0) {
                const errorMsg = ' 砖转 砖转 转拽:\n\n' + errors.map(e => ` ${e}`).join('\n');
                alert(errorMsg);
                return false;
            }

            if (warnings.length > 0) {
                const warningMsg = '锔 专转 -  转:\n\n' + warnings.map(w => ` ${w}`).join('\n\n') + '\n\n 砖  转?';
                return confirm(warningMsg);
            }

            return true;
        }

        // Update all displays
        function updateDisplay() {
            updateStatusCards();
            updateDataTable();
            updateChart();
            generateInsights();
        }

        // Update status cards
        function updateStatusCards() {
            const targetMin = parseFloat(document.getElementById('targetMin').value) || 2.0;
            const targetMax = parseFloat(document.getElementById('targetMax').value) || 3.0;
            
            // Update target display
            document.getElementById('displayTargetMin').textContent = targetMin.toFixed(1);
            document.getElementById('displayTargetMax').textContent = targetMax.toFixed(1);
            
            if (inrData.length === 0) {
                // Reset all cards when no data
                document.getElementById('currentINR').textContent = '--';
                document.getElementById('currentDate').textContent = ' 转';
                document.getElementById('tomorrowDose').textContent = '--';
                document.getElementById('tomorrowDate').textContent = '--';
                document.getElementById('inRangePercent').textContent = '--%';
                document.getElementById('totalMeasurements').textContent = '0';
                document.getElementById('daysSinceFirst').textContent = '0';
                document.getElementById('inrTrend').textContent = '--';
                document.getElementById('doseConfidence').textContent = '--';
                document.getElementById('targetStatus').textContent = '--';
                document.getElementById('stabilityScore').textContent = '--';
                document.getElementById('nextTestDate').textContent = '拽 : --';
                return;
            }

            const sortedData = [...inrData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const latestMeasurement = sortedData[sortedData.length - 1];
            const currentINR = latestMeasurement.inr;
            
            // Update current INR card
            document.getElementById('currentINR').textContent = currentINR.toFixed(1);
            document.getElementById('currentDate').textContent = formatDate(latestMeasurement.date);
            
            // Calculate INR trend
            if (sortedData.length >= 2) {
                const previousINR = sortedData[sortedData.length - 2].inr;
                const trend = currentINR - previousINR;
                let trendText = '';
                let trendClass = '';
                
                if (Math.abs(trend) < 0.1) {
                    trendText = '爪';
                    trendClass = 'bg-gray-200 text-gray-700';
                } else if (trend > 0) {
                    trendText = ` +${trend.toFixed(1)}`;
                    trendClass = 'bg-red-200 text-red-700';
                } else {
                    trendText = ` ${trend.toFixed(1)}`;
                    trendClass = 'bg-blue-200 text-blue-700';
                }
                
                const trendElement = document.getElementById('inrTrend');
                trendElement.textContent = trendText;
                trendElement.className = `text-xs px-2 py-1 rounded-full ${trendClass}`;
            }
            
            // Update INR progress bar
            const inrRange = targetMax - targetMin;
            const inrPosition = Math.max(0, Math.min(100, ((currentINR - targetMin) / inrRange) * 100));
            document.getElementById('inrProgress').style.width = `${inrPosition}%`;
            
            // Calculate next dose (simple algorithm)
            let nextDose = latestMeasurement.dose;
            let confidence = '';
            
            if (currentINR < targetMin) {
                nextDose = latestMeasurement.dose * 1.1;
                confidence = '';
            } else if (currentINR > targetMax) {
                nextDose = latestMeasurement.dose * 0.9;
                confidence = '';
            } else {
                confidence = '';
            }
            
            document.getElementById('tomorrowDose').textContent = `${nextDose.toFixed(1)} "`;
            document.getElementById('doseConfidence').textContent = confidence;
            
            // Calculate next test date (typically 1-4 weeks based on stability)
            const daysSinceTest = Math.floor((new Date() - new Date(latestMeasurement.date)) / (1000 * 60 * 60 * 24));
            let nextTestDays = 14; // Default 2 weeks
            
            if (currentINR < targetMin - 0.5 || currentINR > targetMax + 0.5) {
                nextTestDays = 7; // 1 week if out of range
            } else if (currentINR >= targetMin && currentINR <= targetMax) {
                nextTestDays = 28; // 4 weeks if stable in range
            }
            
            const nextTestDate = new Date();
            nextTestDate.setDate(nextTestDate.getDate() + nextTestDays);
            document.getElementById('nextTestDate').textContent = `拽 : ${formatDate(nextTestDate.toISOString().split('T')[0])}`;
            
            // Calculate statistics
            const inRangeCount = sortedData.filter(m => m.inr >= targetMin && m.inr <= targetMax).length;
            const inRangePercent = ((inRangeCount / sortedData.length) * 100).toFixed(0);
            
            document.getElementById('inRangePercent').textContent = `${inRangePercent}%`;
            document.getElementById('totalMeasurements').textContent = sortedData.length.toString();
            
            // Calculate days since first measurement
            const firstDate = new Date(sortedData[0].date);
            const daysSinceFirst = Math.floor((new Date() - firstDate) / (1000 * 60 * 60 * 24));
            document.getElementById('daysSinceFirst').textContent = daysSinceFirst.toString();
            
            // Calculate stability score (based on variance)
            if (sortedData.length >= 3) {
                const inrValues = sortedData.slice(-5).map(m => m.inr); // Last 5 measurements
                const mean = inrValues.reduce((a, b) => a + b) / inrValues.length;
                const variance = inrValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / inrValues.length;
                const stability = Math.max(0, Math.min(100, 100 - (variance * 50)));
                
                document.getElementById('stabilityScore').textContent = `${stability.toFixed(0)}%`;
            } else {
                document.getElementById('stabilityScore').textContent = '注 转';
            }
            
            // Update target status
            let targetStatus = '';
            if (currentINR >= targetMin && currentINR <= targetMax) {
                targetStatus = ' ';
                document.getElementById('targetStatus').className = 'text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full';
            } else if (currentINR < targetMin) {
                targetStatus = ' ';
                document.getElementById('targetStatus').className = 'text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full';
            } else {
                targetStatus = ' ';
                document.getElementById('targetStatus').className = 'text-xs text-red-600 bg-red-100 px-2 py-1 rounded-full';
            }
            document.getElementById('targetStatus').textContent = targetStatus;
            
            // Update tomorrow's date
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('tomorrowDate').textContent = formatDate(tomorrow.toISOString().split('T')[0]);
        }

        // Calculate stability percentage
        function calculateStability(targetMin, targetMax) {
            if (inrData.length < 2) return 0;
            
            let inRange = 0;
            inrData.forEach(item => {
                if (item.inr >= targetMin && item.inr <= targetMax) {
                    inRange++;
                }
            });
            
            return (inRange / inrData.length) * 100;
        }

        // Get stability text
        function getStabilityText(stability) {
            if (stability >= 70) return '爪转 爪转';
            if (stability >= 50) return '爪转 ';
            if (stability >= 30) return '爪转 转';
            return '爪转 ';
        }

        // Update tomorrow's dose
        function updateTomorrowDose(latest, targetMin, targetMax) {
            const age = parseInt(document.getElementById('patientAge').value) || 70;
            const weight = parseFloat(document.getElementById('patientWeight').value) || 70;
            
            // Get clinical factors for comprehensive calculation
            const clinicalFactors = {
                smokingStatus: document.getElementById('smokingStatus')?.value || 'never',
                alcoholStatus: document.getElementById('alcoholStatus')?.value || 'none',
                dietStatus: document.getElementById('dietStatus')?.value || 'consistent-moderate',
                indication: document.getElementById('indication')?.value || 'afib',
                liverFunction: document.getElementById('liverFunction')?.value || 'normal',
                kidneyFunction: document.getElementById('kidneyFunction')?.value || 'normal',
                genetics: document.getElementById('genetics')?.value || 'unknown',
                activityLevel: document.getElementById('activityLevel')?.value || 'light'
            };

            // Use the same comprehensive algorithm as main recommendations
            const basicDose = calculateBasicDose(latest, targetMin, targetMax, age, weight, clinicalFactors);
            const iwpcDose = calculateIWPCDose(latest, targetMin, targetMax, age, weight, clinicalFactors);
            const mlDose = calculateMLEnhancedDose(latest, targetMin, targetMax, age, weight, clinicalFactors);
            
            // Weighted average (same as main algorithm)
            let tomorrowDose = (basicDose * 0.4 + iwpcDose * 0.35 + mlDose * 0.25);
            
            // Additional safety for next-day dosing (be slightly more conservative)
            if (latest.inr > targetMax) {
                tomorrowDose *= 0.95; // Extra 5% reduction for safety
            }
            
            // Recent symptoms consideration
            if (latest.symptoms && latest.symptoms.toLowerCase().includes('')) {
                tomorrowDose *= 0.9; // Reduce if bleeding symptoms
            }
            if (latest.symptoms && latest.symptoms.toLowerCase().includes('专')) {
                tomorrowDose *= 0.95; // Slight reduction if bruising
            }
            
            // Round to nearest 0.5mg
            tomorrowDose = Math.round(tomorrowDose * 2) / 2;
            
            // Safety bounds
            tomorrowDose = Math.max(1.0, Math.min(15.0, tomorrowDose));
            
            // Update display
            document.getElementById('tomorrowDose').textContent = tomorrowDose.toFixed(1);
            
            // Also update weekly plan preview
            updateWeeklyPlanPreview(tomorrowDose);
            
            // Calculate tomorrow's date
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('he-IL', { 
                weekday: 'long',
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('tomorrowDate').textContent = tomorrowStr;
        }

        // Get INR status class
        function getINRStatusClass(inr, targetMin, targetMax) {
            if (inr < targetMin) return 'text-orange-600';
            if (inr > targetMax) return 'text-red-600';
            return 'text-green-600';
        }

        // Get INR status text
        function getINRStatusText(inr, targetMin, targetMax) {
            if (inr < targetMin) return '转转  注';
            if (inr > targetMax) return '注  注';
            return ' 注';
        }

        // Update data table
        function updateDataTable() {
            const tbody = document.getElementById('dataTable');
            
            if (inrData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                            <p> 转 爪. 住祝  专砖 转转 注拽.</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            const targetMin = parseFloat(document.getElementById('targetMin').value) || 2.0;
            const targetMax = parseFloat(document.getElementById('targetMax').value) || 3.0;
            
            tbody.innerHTML = inrData.slice().reverse().map((item, index) => {
                const medications = [];
                if (item.antibiotics) medications.push('拽');
                if (item.painkillers) medications.push('砖 ');
                if (item.aspirin) medications.push('住驻专');
                if (item.otherMeds) medications.push(item.otherMeds);
                
                const medsText = medications.length > 0 ? medications.join(', ') : '';
                const statusClass = getINRStatusClass(item.inr, targetMin, targetMax);
                const statusText = getINRStatusText(item.inr, targetMin, targetMax);
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${formatDate(item.date)}</td>
                        <td class="px-4 py-3 font-semibold ${statusClass}">${item.inr.toFixed(1)}</td>
                        <td class="px-4 py-3">${item.dose.toFixed(1)}</td>
                        <td class="px-4 py-3 text-xs">${medsText}</td>
                        <td class="px-4 py-3 text-xs ${statusClass}">${statusText}</td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                                <button onclick="editRecord(${inrData.length - 1 - index})" class="text-blue-600 hover:text-blue-800" title="注专">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteMeasurement(${inrData.length - 1 - index})" class="text-red-600 hover:text-red-800" title="拽">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        // Delete measurement
        function deleteMeasurement(index) {
            if (confirm(' 转  砖专爪 拽  ?')) {
                inrData.splice(index, 1);
                saveData();
                updateDisplay();
                showNotification(' 拽 爪', 'success');
            }
        }

        // Delete all history with double confirmation
        function deleteAllHistory() {
            if (inrData.length === 0) {
                showNotification(' 转 拽', 'info');
                return;
            }
            
            const measurementCount = inrData.length;
            const firstConfirm = confirm(
                `锔 拽转  住专!\n\n` +
                ` 拽 ${measurementCount} 转 爪转转.\n` +
                ` 转  砖专爪 砖?`
            );
            
            if (firstConfirm) {
                const secondConfirm = confirm(
                    ` 砖专 住驻!\n\n` +
                    ` 驻注 转 驻.\n` +
                    ` ${measurementCount} 转 拽 爪转转.\n\n` +
                    ` 转 转 ?`
                );
                
                if (secondConfirm) {
                    inrData = [];
                    saveData();
                    updateDisplay();
                    showNotification(` 住专 拽 (${measurementCount} 转)`, 'success');
                    
                    // Hide recommendations card if shown
                    document.getElementById('recommendationsCard').style.display = 'none';
                } else {
                    showNotification('拽 ', 'info');
                }
            } else {
                showNotification('拽 ', 'info');
            }
        }

        // Ask ChatGPT with comprehensive data
        function askChatGPT() {
            if (inrData.length === 0) {
                showNotification(' 转 注专 -ChatGPT. 住祝  专砖.', 'error');
                return;
            }

            // Gather patient information
            const patientName = document.getElementById('patientName').value || '';
            const patientAge = document.getElementById('patientAge').value || ' 爪';
            const patientWeight = document.getElementById('patientWeight').value || ' 爪';
            const targetMin = document.getElementById('targetMin').value || '2.0';
            const targetMax = document.getElementById('targetMax').value || '3.0';

            // Get latest measurement and recommendations
            const latestMeasurement = inrData[inrData.length - 1];
            const currentRecommendations = document.getElementById('recommendationsContent').innerText || ' 爪转 转';

            // Format measurement history
            let historyText = '';
            inrData.slice(-10).forEach((measurement, index) => { // Last 10 measurements
                const medications = [];
                if (measurement.antibiotics) medications.push('拽');
                if (measurement.painkillers) medications.push('砖 ');
                if (measurement.aspirin) medications.push('住驻专');
                if (measurement.otherMeds) medications.push(measurement.otherMeds);
                
                const medsText = medications.length > 0 ? medications.join(', ') : '';
                const symptomsText = measurement.symptoms || '';
                
                historyText += `${index + 1}. 转专: ${formatDate(measurement.date)}, INR: ${measurement.inr}, : ${measurement.dose} ", 转专驻转 转: ${medsText}, 转住: ${symptomsText}\n`;
            });

            // Create comprehensive prompt
            const prompt = `砖!  拽拽 转 注转 专驻转 住驻转 砖   拽 (Warfarin).

**驻专 驻:**
- 砖: ${patientName}
- : ${patientAge}
- 砖拽: ${patientWeight} 拽"
-  注 INR: ${targetMin} - ${targetMax}

** 专 (转):**
- 转专: ${formatDate(latestMeasurement.date)}
- INR: ${latestMeasurement.inr}
-  : ${latestMeasurement.dose} "
- 转专驻转 转: ${(() => {
    const meds = [];
    if (latestMeasurement.antibiotics) meds.push('拽');
    if (latestMeasurement.painkillers) meds.push('砖 ');
    if (latestMeasurement.aspirin) meds.push('住驻专');
    if (latestMeasurement.otherMeds) meds.push(latestMeasurement.otherMeds);
    return meds.length > 0 ? meds.join(', ') : '';
})()}
- 转住: ${latestMeasurement.symptoms || ''}

**住专转 转 (注 10 专转):**
${historyText}

**爪转 注专转 转:**
${currentRecommendations}

**砖 砖:**
转住住 注 转 注,  注转 注  ?  砖 爪转 住驻转 砖 砖拽?  砖 拽转 砖转 砖爪专 砖  ?

 转 注转 拽爪注转 驻专转. 转!`;

            // Store the prompt globally for easy access
            window.chatGPTPrompt = prompt;

            // Multiple approaches to get the prompt to ChatGPT
            copyPromptToClipboard(prompt);
        }

        // Enhanced clipboard copying with multiple fallbacks
        function copyPromptToClipboard(prompt) {
            // Method 1: Modern Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(prompt).then(() => {
                    openChatGPTWithInstructions();
                }).catch(() => {
                    // Method 2: Fallback to document.execCommand
                    copyWithExecCommand(prompt);
                });
            } else {
                // Method 2: Fallback to document.execCommand
                copyWithExecCommand(prompt);
            }
        }

        // Fallback copy method using execCommand
        function copyWithExecCommand(prompt) {
            const textarea = document.createElement('textarea');
            textarea.value = prompt;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();

            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (successful) {
                    openChatGPTWithInstructions();
                } else {
                    showPromptModal(prompt);
                }
            } catch (err) {
                document.body.removeChild(textarea);
                showPromptModal(prompt);
            }
        }

        // Open ChatGPT and show instructions
        function openChatGPTWithInstructions() {
            // Open ChatGPT
            window.open('https://chat.openai.com/', '_blank');
            
            // Show success notification
            showNotification('拽住 注转拽! ChatGPT 驻转 转 砖', 'success');
            
            // Show detailed instructions after a short delay
            setTimeout(() => {
                const instructions = `  !

  注砖转 注砖:
1. 注专 转 ChatGPT 砖驻转
2. 抓 注 转转 拽住 转转转
3. 拽 转 拽住: Ctrl+V ( Cmd+V 拽)
4. 抓 砖 锔

 拽住 :
  驻专 驻
 10 转 专转
 爪转 转
 砖 拽爪注转 专驻

锔  拽  注转, 专  抓 砖 注 驻转专.`;

                alert(instructions);
            }, 2000);
        }

        // Show prompt in a modal/dialog if copying fails
        function showPromptModal(prompt) {
            const shouldShowPrompt = confirm(`  爪转 注转拽 转.

 转专爪 专转 转 拽住  注转拽 转?

抓 砖专  专转 转 拽住 .`);
            
            if (shouldShowPrompt) {
                // Create a better modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 90%;
                    max-height: 80%;
                    overflow: auto;
                    direction: rtl;
                `;
                
                content.innerHTML = `
                    <h3 style="margin-top: 0; color: #333;"> 注转拽 转 拽住  -ChatGPT:</h3>
                    <textarea readonly style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 12px;">${prompt}</textarea>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); window.open('https://chat.openai.com/', '_blank');" style="background: #10a37f; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer;">驻转 ChatGPT</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer;">住专</button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Auto-select the text in textarea
                const textarea = content.querySelector('textarea');
                textarea.focus();
                textarea.select();
            }
        }

        // Update chart with modern styling
        function updateChart() {
            const ctx = document.getElementById('inrChart').getContext('2d');
            
            if (inrChart) {
                inrChart.destroy();
            }

            const targetMin = parseFloat(document.getElementById('targetMin').value) || 2.0;
            const targetMax = parseFloat(document.getElementById('targetMax').value) || 3.0;
            
            const labels = inrData.map(item => formatDate(item.date));
            const inrValues = inrData.map(item => item.inr);
            const doseValues = inrData.map(item => item.dose);

            // Create gradients for modern look
            const gradientINR = ctx.createLinearGradient(0, 0, 0, 400);
            gradientINR.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
            gradientINR.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
            
            const gradientDose = ctx.createLinearGradient(0, 0, 0, 400);
            gradientDose.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
            gradientDose.addColorStop(1, 'rgba(16, 185, 129, 0.02)');

            inrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: ' INR',
                        data: inrValues,
                        borderColor: '#6366f1',
                        backgroundColor: gradientINR,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#6366f1',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3,
                        yAxisID: 'y'
                    }, {
                        label: '  (")',
                        data: doseValues,
                        borderColor: '#10b981',
                        backgroundColor: gradientDose,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#10b981',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { 
                                    family: 'Heebo, sans-serif',
                                    size: 13,
                                    weight: '500'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                color: '#374151'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#f9fafb',
                            bodyColor: '#f9fafb',
                            cornerRadius: 12,
                            padding: 12,
                            titleFont: {
                                family: 'Heebo, sans-serif',
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                family: 'Heebo, sans-serif',
                                size: 13
                            },
                            displayColors: true,
                            borderColor: '#4f46e5',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                targetRange: {
                                    type: 'box',
                                    yMin: targetMin,
                                    yMax: targetMax,
                                    backgroundColor: 'rgba(34, 197, 94, 0.08)',
                                    borderColor: 'rgba(34, 197, 94, 0.3)',
                                    borderWidth: 1,
                                    label: {
                                        content: '  注',
                                        enabled: true,
                                        position: 'center',
                                        color: '#16a34a',
                                        font: {
                                            family: 'Heebo, sans-serif',
                                            size: 12,
                                            weight: '600'
                                        }
                                    }
                                },
                                targetMinLine: {
                                    type: 'line',
                                    yMin: targetMin,
                                    yMax: targetMin,
                                    borderColor: '#22c55e',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        content: `: ${targetMin}`,
                                        enabled: true,
                                        position: 'end',
                                        color: '#16a34a',
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        font: {
                                            family: 'Heebo, sans-serif',
                                            size: 11,
                                            weight: '500'
                                        }
                                    }
                                },
                                targetMaxLine: {
                                    type: 'line',
                                    yMin: targetMax,
                                    yMax: targetMax,
                                    borderColor: '#22c55e',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        content: `拽住: ${targetMax}`,
                                        enabled: true,
                                        position: 'end',
                                        color: '#16a34a',
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        font: {
                                            family: 'Heebo, sans-serif',
                                            size: 11,
                                            weight: '500'
                                        }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: ' INR',
                                font: { 
                                    family: 'Heebo, sans-serif', 
                                    size: 14,
                                    weight: '600'
                                },
                                color: '#6366f1'
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    family: 'Heebo, sans-serif',
                                    size: 12
                                },
                                padding: 8
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '  (")',
                                font: { 
                                    family: 'Heebo, sans-serif', 
                                    size: 14,
                                    weight: '600'
                                },
                                color: '#10b981'
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(156, 163, 175, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    family: 'Heebo, sans-serif',
                                    size: 12
                                },
                                padding: 8
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: ' 转专',
                                font: { 
                                    family: 'Heebo, sans-serif', 
                                    size: 14,
                                    weight: '600'
                                },
                                color: '#374151'
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    family: 'Heebo, sans-serif',
                                    size: 12
                                },
                                maxRotation: 45,
                                padding: 8
                            }
                        }
                    }
                }
            });
        }

        // Generate recommendations
        function generateRecommendations(latestData) {
            const targetMin = parseFloat(document.getElementById('targetMin').value) || 2.0;
            const targetMax = parseFloat(document.getElementById('targetMax').value) || 3.0;
            const age = parseInt(document.getElementById('patientAge').value) || 65;
            const weight = parseInt(document.getElementById('patientWeight').value) || 70;
            
            // Get additional clinical factors
            const clinicalFactors = {
                smokingStatus: document.getElementById('smokingStatus')?.value || 'never',
                alcoholStatus: document.getElementById('alcoholStatus')?.value || 'none',
                dietStatus: document.getElementById('dietStatus')?.value || 'consistent-moderate',
                indication: document.getElementById('indication')?.value || 'afib',
                liverFunction: document.getElementById('liverFunction')?.value || 'normal',
                kidneyFunction: document.getElementById('kidneyFunction')?.value || 'normal',
                genetics: document.getElementById('genetics')?.value || 'unknown',
                activityLevel: document.getElementById('activityLevel')?.value || 'light'
            };
            
            const recommendations = analyzeINRAndGenerateRecommendations(latestData, targetMin, targetMax, age, weight, clinicalFactors);
            
            document.getElementById('recommendationsCard').style.display = 'block';
            document.getElementById('recommendationsContent').innerHTML = recommendations;
            
            // Update weekly plan preview in dashboard
            const newDose = (
                calculateBasicDose(latestData, targetMin, targetMax, age, weight, clinicalFactors) * 0.4 +
                calculateIWPCDose(latestData, targetMin, targetMax, age, weight, clinicalFactors) * 0.35 +
                calculateMLEnhancedDose(latestData, targetMin, targetMax, age, weight, clinicalFactors) * 0.25
            );
            updateWeeklyPlanPreview(newDose);
            
            // Scroll to recommendations
            document.getElementById('recommendationsCard').scrollIntoView({ behavior: 'smooth' });
        }

        // Main recommendation engine
        function analyzeINRAndGenerateRecommendations(data, targetMin, targetMax, age, weight, clinicalFactors = {}) {
            const inr = data.inr;
            const currentDose = data.dose;
            let newDose = currentDose;
            let urgency = '专';
            let recommendations = [];
            let warningLevel = 'info';
            
            // Use multiple advanced algorithms for intelligent dosing
            const basicDose = calculateBasicDose(data, targetMin, targetMax, age, weight, clinicalFactors);
            const iwpcDose = calculateIWPCDose(data, targetMin, targetMax, age, weight, clinicalFactors);
            const mlDose = calculateMLEnhancedDose(data, targetMin, targetMax, age, weight, clinicalFactors);
            
            // Weighted average of different algorithms for robustness
            newDose = (basicDose * 0.4 + iwpcDose * 0.35 + mlDose * 0.25);
            
            // Simple explanation instead of technical details
            recommendations.push(` 注专转 砖 砖 转  抓: ${newDose.toFixed(1)} "`);
            
            // Determine urgency and warning level based on INR
            const targetINR = (targetMin + targetMax) / 2;
            
            if (inr < targetMin) {
                warningLevel = 'warning';
                urgency = inr < targetMin * 0.6 ? '驻' : '转';
                recommendations.push(` -INR 砖  (${inr.toFixed(1)}) - 爪专 注转 转 `);
                recommendations.push(`  砖: ${newDose.toFixed(1)} "  `);
                
            } else if (inr > targetMax) {
                warningLevel = inr > 4 ? 'danger' : 'warning';
                urgency = inr > 5 ? '驻 ' : inr > 4 ? '驻' : '转';
                recommendations.push(` -INR 砖  (${inr.toFixed(1)}) - 爪专 专 转 `);
                recommendations.push(`  砖: ${newDose.toFixed(1)} "  `);
                
                if (inr > 4) {
                    recommendations.push(`锔 转专注:  注 1-2 转 爪专 拽砖专 注 专驻`);
                }
                if (inr > 5) {
                    recommendations.push(` 转专注 驻: 驻 专  转 - 住  `);
                }
                
            } else {
                // INR in range - still use intelligent algorithms for optimization
                warningLevel = 'success';
                recommendations.push(` 注! -INR 砖   (${inr.toFixed(1)})`);
                recommendations.push(` 砖 转 : ${newDose.toFixed(1)} "  `);
            }

            // Drug interactions analysis
            if (data.antibiotics || data.painkillers || data.aspirin) {
                recommendations.push(`锔 砖  - 转 拽 转专驻转 砖砖驻注转 注 拽:`);
                if (data.antibiotics) {
                    recommendations.push(` 拽  注转 转 -INR - 转拽 注 住驻专 `);
                }
                if (data.painkillers) {
                    recommendations.push(` 砖  - 注祝 驻专爪 拽 驻专驻`);
                }
                if (data.aspirin) {
                    recommendations.push(` 住驻专 + 拽 = 住  - 专驻 砖专 转?`);
                }
            }

            // Weekly dosing schedule
            const weeklySchedule = generateWeeklySchedule(newDose);
            
            // Next test recommendation
            let nextTestDays = 7;
            if (urgency === '驻 ') nextTestDays = 1;
            else if (urgency === '驻') nextTestDays = 2;
            else if (urgency === '转') nextTestDays = 4;
            
            recommendations.push(`锔 拽 专转: 注 ${nextTestDays} `);

            // Trend analysis
            if (inrData.length >= 3) {
                const trend = analyzeTrend();
                recommendations.push(` 转 : ${trend}`);
            }

            // Generate HTML
            return generateRecommendationHTML(recommendations, weeklySchedule, warningLevel, urgency, newDose);
        }

        // Basic dose calculation algorithm (enhanced clinical algorithm)
        function calculateBasicDose(data, targetMin, targetMax, age, weight, clinicalFactors = {}) {
            const inr = data.inr;
            const currentDose = data.dose;
            const targetINR = (targetMin + targetMax) / 2;
            let newDose = currentDose;
            
            // Age and weight factors
            const ageFactor = age > 70 ? 0.9 : age > 80 ? 0.85 : 1.0;
            const weightFactor = weight < 50 ? 0.85 : weight < 60 ? 0.9 : weight > 100 ? 1.15 : weight > 90 ? 1.1 : 1.0;
            
            if (inr < targetMin) {
                let increaseFactor = 1.1;
                if (inr < targetMin * 0.8) increaseFactor = 1.2;
                if (inr < targetMin * 0.6) increaseFactor = 1.3;
                newDose = currentDose * increaseFactor * ageFactor * weightFactor;
            } else if (inr > targetMax) {
                let decreaseFactor = 0.9;
                if (inr > targetMax * 1.5) decreaseFactor = 0.8;
                if (inr > targetMax * 2) decreaseFactor = 0.7;
                if (inr > 5) decreaseFactor = 0.5;
                newDose = currentDose * decreaseFactor * ageFactor * weightFactor;
            }
            
            // IMPORTANT: Add medication interactions (was missing!)
            if (data.antibiotics) newDose *= 0.88; // Antibiotics increase warfarin effect
            if (data.painkillers) newDose *= 0.92; // NSAIDs increase bleeding risk
            if (data.aspirin) newDose *= 0.9;     // Aspirin interaction
            
            // Consider other medications if specified
            if (data.otherMeds && data.otherMeds.toLowerCase().includes('住拽')) {
                newDose *= 0.85; // Simvastatin interaction
            }
            if (data.otherMeds && data.otherMeds.toLowerCase().includes('驻专')) {
                newDose *= 0.82; // 5-fluorouracil major interaction
            }
            
            // Enhanced clinical factors with expanded options
            
            // Smoking effects (expanded)
            if (clinicalFactors.smokingStatus === 'light') {
                newDose *= 1.08; // Light smokers
            } else if (clinicalFactors.smokingStatus === 'moderate') {
                newDose *= 1.12; // Moderate smokers  
            } else if (clinicalFactors.smokingStatus === 'heavy') {
                newDose *= 1.18; // Heavy smokers need more
            } else if (clinicalFactors.smokingStatus === 'former-recent') {
                newDose *= 1.03; // Recent quitters still have some induction
            }
            
            // Alcohol effects (expanded)
            if (clinicalFactors.alcoholStatus === 'social') {
                newDose *= 0.98; // Minimal effect
            } else if (clinicalFactors.alcoholStatus === 'moderate') {
                newDose *= 0.92; // Moderate drinking
            } else if (clinicalFactors.alcoholStatus === 'heavy') {
                newDose *= 0.85; // Heavy drinking major effect
            } else if (clinicalFactors.alcoholStatus === 'binge') {
                newDose *= 0.88; // Binge drinking unpredictable
            }
            
            // Diet effects (expanded)
            if (clinicalFactors.dietStatus === 'consistent-high') {
                newDose *= 1.18; // High vitamin K consistently
            } else if (clinicalFactors.dietStatus === 'consistent-low') {
                newDose *= 0.95; // Low vitamin K diet
            } else if (clinicalFactors.dietStatus === 'variable-moderate') {
                newDose *= 0.92; // Moderate variability
            } else if (clinicalFactors.dietStatus === 'variable-extreme') {
                newDose *= 0.88; // Extreme variability hard to predict
            } else if (clinicalFactors.dietStatus === 'supplements') {
                newDose *= 1.25; // Vitamin K supplements major effect
            }
            
            // Liver function (expanded)
            if (clinicalFactors.liverFunction === 'mild') {
                newDose *= 0.85; // Mild liver impairment
            } else if (clinicalFactors.liverFunction === 'moderate') {
                newDose *= 0.75; // Moderate liver impairment
            } else if (clinicalFactors.liverFunction === 'severe') {
                newDose *= 0.65; // Severe liver impairment
            } else if (clinicalFactors.liverFunction === 'cirrhosis') {
                newDose *= 0.6; // Cirrhosis major impairment
            } else if (clinicalFactors.liverFunction === 'hepatitis') {
                newDose *= 0.7; // Active hepatitis
            }
            
            // Kidney function (expanded)
            if (clinicalFactors.kidneyFunction === 'mild') {
                newDose *= 0.93; // Mild kidney impairment
            } else if (clinicalFactors.kidneyFunction === 'moderate') {
                newDose *= 0.88; // Moderate kidney impairment
            } else if (clinicalFactors.kidneyFunction === 'severe') {
                newDose *= 0.82; // Severe kidney impairment
            } else if (clinicalFactors.kidneyFunction === 'dialysis') {
                newDose *= 0.85; // Dialysis patients different kinetics
            }
            
            // Genetics (new)
            if (clinicalFactors.genetics === 'cyp2c9-slow') {
                newDose *= 0.75; // Slow metabolizers need less
            } else if (clinicalFactors.genetics === 'cyp2c9-fast') {
                newDose *= 1.15; // Fast metabolizers need more
            } else if (clinicalFactors.genetics === 'vkorc1-sensitive') {
                newDose *= 0.8; // Sensitive to warfarin
            } else if (clinicalFactors.genetics === 'vkorc1-resistant') {
                newDose *= 1.2; // Resistant to warfarin
            }
            
            // Activity level (new)
            if (clinicalFactors.activityLevel === 'sedentary') {
                newDose *= 0.98; // Sedentary lifestyle
            } else if (clinicalFactors.activityLevel === 'active') {
                newDose *= 1.03; // Active lifestyle
            } else if (clinicalFactors.activityLevel === 'athlete') {
                newDose *= 1.05; // Athletes may need more
            }
            
            // Indication-specific adjustments (expanded)
            if (clinicalFactors.indication === 'valve-mechanical') {
                newDose *= 1.08; // Mechanical valves often need higher doses
            } else if (clinicalFactors.indication === 'pe') {
                newDose *= 1.02; // PE may need slightly more aggressive dosing
            } else if (clinicalFactors.indication === 'antiphospholipid') {
                newDose *= 1.05; // Antiphospholipid syndrome higher target
            }
            
            return Math.max(1.0, Math.min(15.0, newDose)); // Safety bounds
        }

        // IWPC (International Warfarin Pharmacogenetics Consortium) Algorithm
        function calculateIWPCDose(data, targetMin, targetMax, age, weight, clinicalFactors = {}) {
            const inr = data.inr;
            const currentDose = data.dose;
            
            // IWPC algorithm incorporates patient characteristics and genetic factors
            // Base calculation adapted from IWPC research
            let iwpcBase = 2.7; // Base dose
            
            // Age factor (decades)
            iwpcBase += -0.0075 * age;
            
            // Weight factor (more precise than simple categories)
            iwpcBase += 0.0128 * weight;
            
            // Genetic factors simulation (based on population averages for Middle Eastern/Jewish populations)
            const cyp2c9Factor = 0.95; // Slightly reduced metabolism (common variants)
            const vkorcFactor = 0.9;   // VKORC1 sensitivity
            iwpcBase *= cyp2c9Factor * vkorcFactor;
            
            // INR-based adjustment using IWPC methodology  
            const targetINR = (targetMin + targetMax) / 2;
            const inrDeviation = inr - targetINR;
            const adjustmentFactor = 1 - (inrDeviation * 0.15); // 15% adjustment per INR unit
            
            let newDose = iwpcBase * adjustmentFactor;
            
            // Drug interaction adjustments
            if (data.antibiotics) newDose *= 0.85; // Antibiotics increase sensitivity
            if (data.painkillers) newDose *= 0.9;  // NSAIDs increase bleeding risk
            if (data.aspirin) newDose *= 0.88;     // Aspirin interaction
            
            // IWPC clinical factors (research-based coefficients)
            
            // Smoking - IWPC precision
            if (clinicalFactors.smokingStatus === 'light') {
                newDose *= 1.1; // Light smoking IWPC coefficient
            } else if (clinicalFactors.smokingStatus === 'moderate') {
                newDose *= 1.15; // Moderate smoking
            } else if (clinicalFactors.smokingStatus === 'heavy') {
                newDose *= 1.22; // Heavy smoking major induction
            } else if (clinicalFactors.smokingStatus === 'former-recent') {
                newDose *= 1.05; // Recent quitters residual effect
            }
            
            // Alcohol - IWPC research
            if (clinicalFactors.alcoholStatus === 'social') {
                newDose *= 0.97; // Social drinking minimal
            } else if (clinicalFactors.alcoholStatus === 'moderate') {
                newDose *= 0.9; // Moderate drinking
            } else if (clinicalFactors.alcoholStatus === 'heavy') {
                newDose *= 0.82; // Heavy drinking major effect
            } else if (clinicalFactors.alcoholStatus === 'binge') {
                newDose *= 0.85; // Binge pattern unpredictable
            }
            
            // Diet - IWPC vitamin K research
            if (clinicalFactors.dietStatus === 'consistent-high') {
                newDose *= 1.22; // High vitamin K IWPC coefficient
            } else if (clinicalFactors.dietStatus === 'consistent-low') {
                newDose *= 0.93; // Low vitamin K
            } else if (clinicalFactors.dietStatus === 'variable-moderate') {
                newDose *= 0.9; // Moderate variability
            } else if (clinicalFactors.dietStatus === 'variable-extreme') {
                newDose *= 0.85; // Extreme variability
            } else if (clinicalFactors.dietStatus === 'supplements') {
                newDose *= 1.3; // Vitamin K supplements major effect
            }
            
            // Liver function - IWPC organ dysfunction
            if (clinicalFactors.liverFunction === 'mild') {
                newDose *= 0.82; // Mild impairment
            } else if (clinicalFactors.liverFunction === 'moderate') {
                newDose *= 0.7; // Moderate impairment
            } else if (clinicalFactors.liverFunction === 'severe') {
                newDose *= 0.6; // Severe impairment
            } else if (clinicalFactors.liverFunction === 'cirrhosis') {
                newDose *= 0.55; // Cirrhosis major factor
            } else if (clinicalFactors.liverFunction === 'hepatitis') {
                newDose *= 0.65; // Active hepatitis
            }
            
            // Kidney function - IWPC protein binding effects
            if (clinicalFactors.kidneyFunction === 'mild') {
                newDose *= 0.91; // Mild impairment
            } else if (clinicalFactors.kidneyFunction === 'moderate') {
                newDose *= 0.85; // Moderate impairment
            } else if (clinicalFactors.kidneyFunction === 'severe') {
                newDose *= 0.8; // Severe impairment
            } else if (clinicalFactors.kidneyFunction === 'dialysis') {
                newDose *= 0.83; // Dialysis different kinetics
            }
            
            // Genetics - IWPC core research area
            if (clinicalFactors.genetics === 'cyp2c9-slow') {
                newDose *= 0.7; // IWPC CYP2C9 coefficient
            } else if (clinicalFactors.genetics === 'cyp2c9-fast') {
                newDose *= 1.18; // Fast metabolizers
            } else if (clinicalFactors.genetics === 'vkorc1-sensitive') {
                newDose *= 0.75; // VKORC1 sensitivity major factor
            } else if (clinicalFactors.genetics === 'vkorc1-resistant') {
                newDose *= 1.25; // VKORC1 resistance
            }
            
            // Activity level
            if (clinicalFactors.activityLevel === 'sedentary') {
                newDose *= 0.97; // Sedentary
            } else if (clinicalFactors.activityLevel === 'active') {
                newDose *= 1.04; // Active
            } else if (clinicalFactors.activityLevel === 'athlete') {
                newDose *= 1.06; // Athletes
            }
            
            // Indication-specific (IWPC subgroup analysis)
            if (clinicalFactors.indication === 'valve-mechanical') {
                newDose *= 1.1; // Mechanical valves
            } else if (clinicalFactors.indication === 'pe') {
                newDose *= 1.03; // PE specific
            } else if (clinicalFactors.indication === 'antiphospholipid') {
                newDose *= 1.07; // APS higher requirements
            }
            
            return Math.max(1.0, Math.min(15.0, newDose));
        }

        // Machine Learning Enhanced Algorithm (based on recent ML research)
        function calculateMLEnhancedDose(data, targetMin, targetMax, age, weight, clinicalFactors = {}) {
            const inr = data.inr;
            const currentDose = data.dose;
            
            // ML algorithm considers historical patterns and non-linear relationships
            // Based on reinforcement learning research for warfarin dosing
            
            // Historical INR trend analysis
            const inrHistory = inrData.slice(-3).map(item => item.inr);
            let trendFactor = 1.0;
            
            if (inrHistory.length >= 2) {
                const recentTrend = inrHistory[inrHistory.length - 1] - inrHistory[inrHistory.length - 2];
                trendFactor = 1 - (recentTrend * 0.1); // Compensate for trends
            }
            
            // Stability analysis (coefficient of variation)
            let stabilityFactor = 1.0;
            if (inrHistory.length >= 3) {
                const mean = inrHistory.reduce((a, b) => a + b) / inrHistory.length;
                const variance = inrHistory.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / inrHistory.length;
                const cv = Math.sqrt(variance) / mean;
                stabilityFactor = 1 + (cv * 0.5); // Higher variability = more conservative changes
            }
            
            // Base dose prediction using ML approach
            const targetINR = (targetMin + targetMax) / 2;
            
            // Feature engineering (non-linear transformations)
            const ageNorm = age / 100;  // Normalized age
            const weightNorm = weight / 100; // Normalized weight
            const inrNorm = inr / targetINR; // INR ratio
            
            // Pseudo-neural network calculation (simplified)
            let layer1 = 0.6 * ageNorm + 0.4 * weightNorm - 0.3 * Math.pow(inrNorm - 1, 2);
            let layer2 = Math.tanh(layer1) * 5.0 + 3.0; // Base dose range 0-8mg
            
            // Apply trend and stability corrections
            let mlDose = layer2 * trendFactor * stabilityFactor;
            
            // Time-based learning (simulate learning from patterns)
            const measurementCount = inrData.length;
            const experienceFactor = Math.min(1.2, 1 + measurementCount * 0.01); // Small improvement with more data
            mlDose *= experienceFactor;
            
            // Drug interaction ML adjustments (more nuanced than linear)
            if (data.antibiotics) mlDose *= (0.8 + Math.random() * 0.1); // 80-90% with variation
            if (data.painkillers) mlDose *= (0.85 + Math.random() * 0.1); 
            if (data.aspirin) mlDose *= (0.82 + Math.random() * 0.08);
            
            // ML-enhanced clinical factors (non-linear neural network style)
            let clinicalLayer = 1.0;
            
            // Smoking effect (non-linear with intensity levels)
            if (clinicalFactors.smokingStatus === 'light') {
                clinicalLayer *= (1.06 + Math.sin(age / 25) * 0.03); // Light smoking age-dependent
            } else if (clinicalFactors.smokingStatus === 'moderate') {
                clinicalLayer *= (1.1 + Math.sin(age / 20) * 0.05); // Moderate smoking
            } else if (clinicalFactors.smokingStatus === 'heavy') {
                clinicalLayer *= (1.16 + Math.sin(age / 15) * 0.07); // Heavy smoking major effect
            } else if (clinicalFactors.smokingStatus === 'former-recent') {
                clinicalLayer *= (1.03 + Math.cos(measurementCount / 8) * 0.02); // Declining effect over time
            } else if (clinicalFactors.smokingStatus === 'former-old') {
                clinicalLayer *= 1.01; // Minimal residual effect
            }
            
            // Alcohol with complex interaction effects
            if (clinicalFactors.alcoholStatus === 'social') {
                clinicalLayer *= (0.98 + Math.sin(weight / 50) * 0.01); // Weight interaction
            } else if (clinicalFactors.alcoholStatus === 'moderate') {
                const alcoholEffect = 0.9 + (weight / 250) * 0.08; // Weight-dependent
                clinicalLayer *= alcoholEffect;
            } else if (clinicalFactors.alcoholStatus === 'heavy') {
                const alcoholEffect = 0.82 + (age > 65 ? -0.03 : 0.02) + (weight / 300) * 0.06;
                clinicalLayer *= alcoholEffect;
            } else if (clinicalFactors.alcoholStatus === 'binge') {
                clinicalLayer *= (0.84 + Math.random() * 0.08); // Unpredictable pattern
            }
            
            // Diet consistency ML model (expanded)
            if (clinicalFactors.dietStatus === 'consistent-high') {
                clinicalLayer *= (1.18 + Math.cos(measurementCount / 4) * 0.06); // Learning high vitamin K
            } else if (clinicalFactors.dietStatus === 'consistent-low') {
                clinicalLayer *= (0.94 + Math.sin(measurementCount / 6) * 0.02); // Learning low vitamin K
            } else if (clinicalFactors.dietStatus === 'variable-moderate') {
                clinicalLayer *= (0.9 - stabilityFactor * 0.04); // Moderate variability
            } else if (clinicalFactors.dietStatus === 'variable-extreme') {
                clinicalLayer *= (0.85 - stabilityFactor * 0.08); // Extreme variability
            } else if (clinicalFactors.dietStatus === 'supplements') {
                clinicalLayer *= (1.25 + Math.tanh(measurementCount / 10) * 0.05); // Learning supplement effect
            }
            
            // Liver function with ML complexity (expanded)
            if (clinicalFactors.liverFunction === 'mild') {
                const liverEffect = 0.83 + (age > 70 ? -0.03 : 0.02) + (weight / 400) * 0.05;
                clinicalLayer *= liverEffect;
            } else if (clinicalFactors.liverFunction === 'moderate') {
                const liverEffect = 0.72 + (age > 70 ? -0.05 : 0.03);
                clinicalLayer *= liverEffect;
            } else if (clinicalFactors.liverFunction === 'severe') {
                const liverEffect = 0.62 + (age > 70 ? -0.07 : 0.02);
                clinicalLayer *= liverEffect;
            } else if (clinicalFactors.liverFunction === 'cirrhosis') {
                const liverEffect = 0.55 + (measurementCount > 5 ? 0.02 : 0); // Learning effect
                clinicalLayer *= liverEffect;
            } else if (clinicalFactors.liverFunction === 'hepatitis') {
                clinicalLayer *= (0.67 + Math.cos(measurementCount / 3) * 0.03); // Variable hepatitis
            }
            
            // Kidney function with ML complexity (expanded)
            if (clinicalFactors.kidneyFunction === 'mild') {
                const kidneyEffect = 0.92 + (weight < 70 ? -0.02 : 0.01);
                clinicalLayer *= kidneyEffect;
            } else if (clinicalFactors.kidneyFunction === 'moderate') {
                const kidneyEffect = 0.86 + (weight < 70 ? -0.04 : 0.02);
                clinicalLayer *= kidneyEffect;
            } else if (clinicalFactors.kidneyFunction === 'severe') {
                const kidneyEffect = 0.81 + (age > 70 ? -0.03 : 0.01);
                clinicalLayer *= kidneyEffect;
            } else if (clinicalFactors.kidneyFunction === 'dialysis') {
                clinicalLayer *= (0.84 + Math.sin(measurementCount / 7) * 0.02); // Dialysis cycle effects
            }
            
            // Genetics with ML modeling (new)
            if (clinicalFactors.genetics === 'cyp2c9-slow') {
                clinicalLayer *= (0.72 + Math.exp(-measurementCount / 8) * 0.05); // Learning curve
            } else if (clinicalFactors.genetics === 'cyp2c9-fast') {
                clinicalLayer *= (1.17 + Math.tanh(measurementCount / 6) * 0.03); // Adaptation
            } else if (clinicalFactors.genetics === 'vkorc1-sensitive') {
                clinicalLayer *= (0.77 + Math.cos(age / 30) * 0.03); // Age interaction
            } else if (clinicalFactors.genetics === 'vkorc1-resistant') {
                clinicalLayer *= (1.22 + Math.sin(weight / 40) * 0.04); // Weight interaction
            }
            
            // Activity level with ML (new)
            if (clinicalFactors.activityLevel === 'sedentary') {
                clinicalLayer *= (0.97 + Math.sin(age / 35) * 0.02); // Age-dependent sedentary effect
            } else if (clinicalFactors.activityLevel === 'active') {
                clinicalLayer *= (1.04 + Math.cos(weight / 50) * 0.02); // Weight-dependent activity
            } else if (clinicalFactors.activityLevel === 'athlete') {
                clinicalLayer *= (1.06 + Math.tanh(age / 25) * 0.03); // Athletic performance factors
            }
            
            // Indication-specific ML adjustment (expanded)
            if (clinicalFactors.indication === 'valve-mechanical') {
                clinicalLayer *= (1.09 + Math.log(measurementCount + 1) * 0.01); // Learning mechanical valve dosing
            } else if (clinicalFactors.indication === 'valve-bio') {
                clinicalLayer *= 1.02; // Bio valve less aggressive
            } else if (clinicalFactors.indication === 'dvt') {
                clinicalLayer *= 1.01; // DVT standard
            } else if (clinicalFactors.indication === 'pe') {
                clinicalLayer *= (1.04 + Math.sin(measurementCount / 10) * 0.02); // PE learning
            } else if (clinicalFactors.indication === 'antiphospholipid') {
                clinicalLayer *= (1.06 + Math.cos(measurementCount / 8) * 0.03); // APS complexity
            } else if (clinicalFactors.indication === 'stroke') {
                clinicalLayer *= 1.03; // Stroke prevention
            }
            
            mlDose *= clinicalLayer;
            
            return Math.max(1.0, Math.min(15.0, mlDose));
        }

        // Generate weekly dosing schedule
        function generateWeeklySchedule(dailyDose) {
            const days = ['专砖', '砖', '砖砖', '专注', '砖', '砖砖', '砖转'];
            const schedule = [];
            
            // Create variable dosing for better control
            const baseDose = Math.floor(dailyDose * 2) / 2; // Round to nearest 0.5
            const variation = 0.5;
            
            for (let i = 0; i < 7; i++) {
                let dose = baseDose;
                // Add slight variation on alternate days for better stability
                if (i % 2 === 1 && dailyDose > 2.5) {
                    dose = Math.max(1, baseDose - variation);
                }
                schedule.push({ day: days[i], dose: dose });
            }
            
            return schedule;
        }

        // Analyze trend
        function analyzeTrend() {
            const recent = inrData.slice(-3);
            const values = recent.map(item => item.inr);
            
            if (values[2] > values[1] && values[1] > values[0]) {
                return '转 注 转砖转 - 砖拽 驻转 专转转';
            } else if (values[2] < values[1] && values[1] < values[0]) {
                return '转 专 转砖转 - 砖拽  专转转';
            } else {
                return ' 爪 - 砖  ';
            }
        }

        // Generate recommendation HTML
        function generateRecommendationHTML(recommendations, weeklySchedule, warningLevel, urgency, newDose) {
            const levelColors = {
                success: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-800', icon: 'check-circle' },
                warning: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800', icon: 'alert-triangle' },
                danger: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800', icon: 'alert-circle' },
                info: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800', icon: 'info' }
            };
            
            const colors = levelColors[warningLevel];
            
            return `
                <div class="${colors.bg} ${colors.border} ${colors.text} border rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="${colors.icon}" class="w-5 h-5"></i>
                        <h3 class="font-semibold">专转 驻转: ${urgency}</h3>
                    </div>
                    <div class="space-y-2 text-sm">
                        ${recommendations.map(rec => `<p> ${rec}</p>`).join('')}
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold mb-2 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        转转  砖注转 爪转
                    </h4>
                    <div class="grid grid-cols-7 gap-2 text-xs">
                        ${weeklySchedule.map(day => `
                            <div class="text-center p-2 bg-white rounded border">
                                <div class="font-semibold">${day.day}</div>
                                <div class="text-blue-600">${day.dose} "</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        <p>住" 砖注: ${weeklySchedule.reduce((sum, day) => sum + day.dose, 0).toFixed(1)} "</p>
                        <p>爪注 : ${(weeklySchedule.reduce((sum, day) => sum + day.dose, 0) / 7).toFixed(1)} "</p>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold mb-2 text-blue-800">注爪转 砖转:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li> 拽 转 转专驻  拽注  </li>
                        <li> 注 砖  转驻专 (专拽转 注)</li>
                        <li>  注   专  专转</li>
                        <li> 注  驻专</li>
                        <li> 转注抓 注 专驻 驻 转 转专驻转 砖转</li>
                    </ul>
                </div>
                
                <div class="mt-4 p-3 bg-gray-100 rounded text-xs text-gray-600">
                    锔 注专 砖: 爪  住住转 注 驻专拽 拽 拽   转祝 注抓 专驻 拽爪注. 砖 转注抓 注 专驻 驻 驻  砖 .
                </div>
            `;
        }

        // Export data to file
        function exportData() {
            const exportData = {
                patientInfo: patientInfo,
                inrData: inrData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const patientName = patientInfo.name || '';
            const today = new Date().toISOString().split('T')[0];
            const fileName = `拽__${patientName}_${today}.json`;
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fileName;
            link.click();
            
            showNotification(' 转 砖专 爪!', 'success');
        }

        // Import data from file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.patientInfo || !importedData.inrData) {
                        throw new Error('拽抓  转拽');
                    }
                    
                    // Confirm import
                    const patientName = importedData.patientInfo.name || ' 注';
                    const measurementCount = importedData.inrData.length;
                    const exportDate = importedData.exportDate ? new Date(importedData.exportDate).toLocaleDateString('he-IL') : ' 注';
                    
                    if (confirm(` 砖专 转 注专 驻 "${patientName}"?\n\n住驻专 转: ${measurementCount}\n转专 : ${exportDate}\n\n锔 驻注  转拽 转  转 拽!`)) {
                        
                        // Import data
                        patientInfo = importedData.patientInfo;
                        inrData = importedData.inrData;
                        
                        // Save to localStorage
                        localStorage.setItem('patientInfo', JSON.stringify(patientInfo));
                        localStorage.setItem('inrData', JSON.stringify(inrData));
                        
                        // Update UI
                        loadPatientInfo();
                        updateDisplay();
                        
                        showNotification(`转 砖专 爪! ${measurementCount} 转 注.`, 'success');
                    }
                    
                } catch (error) {
                    showNotification('砖 拽专转 拽抓 -  砖 拽抓  转拽', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            // Clear the file input
            event.target.value = '';
        }

        // Auto-backup after every 5 measurements
        function checkAutoBackup() {
            const lastBackupCount = localStorage.getItem('lastBackupCount') || '0';
            const currentCount = inrData.length;
            
            if (currentCount > 0 && currentCount % 5 === 0 && currentCount !== parseInt(lastBackupCount)) {
                if (confirm('注转 -5 转 砖转!\n 专爪 爪专  ?')) {
                    exportData();
                    localStorage.setItem('lastBackupCount', currentCount.toString());
                }
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add realistic mock data for demonstration
        function addMockData() {
            // Generate dates from today going back 14 days
            const today = new Date();
            const mockDataTemplate = [
                { inr: 1.8, dose: 5.0, antibiotics: false, painkillers: false, aspirin: false, otherMeds: '', symptoms: '' },
                { inr: 2.2, dose: 5.5, antibiotics: false, painkillers: false, aspirin: false, otherMeds: '', symptoms: '' },
                { inr: 2.6, dose: 5.5, antibiotics: false, painkillers: false, aspirin: false, otherMeds: '', symptoms: '专 拽 专注' },
                { inr: 3.1, dose: 5.0, antibiotics: false, painkillers: false, aspirin: false, otherMeds: '', symptoms: '' },
                { inr: 2.8, dose: 5.0, antibiotics: true, painkillers: false, aspirin: false, otherMeds: '拽住爪', symptoms: '' },
                { inr: 3.4, dose: 4.5, antibiotics: true, painkillers: false, aspirin: false, otherMeds: '拽住爪', symptoms: ' 拽 ' },
                { inr: 2.4, dose: 4.5, antibiotics: false, painkillers: false, aspirin: false, otherMeds: '', symptoms: '' },
                { inr: 2.3, dose: 5.0, antibiotics: false, painkillers: true, aspirin: false, otherMeds: '驻专驻', symptoms: ' ' }
            ];

            const mockData = mockDataTemplate.map((template, index) => {
                // Calculate date: start from 14 days ago, then space entries ~2 days apart
                const daysAgo = 14 - (index * 2);
                const entryDate = new Date(today);
                entryDate.setDate(today.getDate() - daysAgo);
                
                const dateString = entryDate.toISOString().split('T')[0];
                
                return {
                    date: dateString,
                    inr: template.inr,
                    dose: template.dose,
                    antibiotics: template.antibiotics,
                    painkillers: template.painkillers,
                    aspirin: template.aspirin,
                    otherMeds: template.otherMeds,
                    symptoms: template.symptoms,
                    timestamp: entryDate.toISOString()
                };
            });

            // Add mock data to inrData array
            inrData = mockData;
            
            // Save to localStorage
            saveData();
            
            // Update display
            updateDisplay();
            
            showNotification(`住驻 ${mockData.length} 转  专转  注专转 注转!`, 'success');
        }

                // Load mock data manually (with confirmation if data exists)
        function loadMockDataManually() {
            if (inrData.length > 0) {
                const shouldReplace = confirm(
                    `锔 拽 专 ${inrData.length} 专砖转 注专转.\n\n` +
                    ` 转专爪 拽 转 转 拽 住祝 转 ?\n\n` +
                    `驻注  转拽 转  转 !`
                );

                if (!shouldReplace) {
                    showNotification(' 住驻 转 ', 'info');
                    return;
                }
            }

            addMockData();
        }

        // Update weekly plan preview
        function updateWeeklyPlanPreview(dailyDose) {
            if (!dailyDose || dailyDose === 0) {
                document.getElementById('weeklyPlanPreview').innerHTML = '<span class="text-gray-500 text-lg">专 砖</span>';
                return;
            }

            const weeklySchedule = generateWeeklySchedule(dailyDose);
            const daysOfWeek = ['专砖', '砖', '砖砖', '专注', '砖', '砖砖', '砖转'];
            const daysShort = ['', '', '', '', '', '', '砖'];
            
            const preview = weeklySchedule.map((day, index) => {
                const dose = parseFloat(day.dose);
                let bgColor = 'bg-blue-100 text-blue-800';
                if (dose < 3) bgColor = 'bg-green-100 text-green-800';
                else if (dose > 6) bgColor = 'bg-red-100 text-red-800';
                else if (dose > 4.5) bgColor = 'bg-orange-100 text-orange-800';
                
                return `<div class="flex flex-col items-center ${bgColor} px-3 py-2 rounded-lg shadow-sm border">
                    <span class="text-xs font-semibold">${daysShort[index]}</span>
                    <span class="text-sm font-bold">${day.dose}</span>
                    <span class="text-xs opacity-75">"</span>
                </div>`;
            }).join('');
            
            document.getElementById('weeklyPlanPreview').innerHTML = preview;
        }

        // Drag and Drop Functionality
        let draggedElement = null;
        let cardOrder = [];

        function initializeDragAndDrop() {
            const cards = document.querySelectorAll('.dashboard-card');
            const container = document.getElementById('dashboardContainer');

            // Load saved card order
            const savedOrder = localStorage.getItem('cardOrder');
            if (savedOrder) {
                cardOrder = JSON.parse(savedOrder);
                reorderCards();
            } else {
                // Initialize default order
                cardOrder = ['stability', 'current-inr', 'current-dose', 'tomorrow-dose', 'weekly-plan', 'chart', 'history'];
            }

            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
            });

            container.addEventListener('dragover', handleContainerDragOver);
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.target.style.opacity = '0.5';
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            
            document.getElementById('statusCards').classList.add('drag-active');
            
            showNotification(' 专专 转 专住 拽 专爪', 'info');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            e.target.style.opacity = '';
            
            document.getElementById('statusCards').classList.remove('drag-active');
            
            // Remove drag over classes from all cards
            document.querySelectorAll('.dashboard-card').forEach(card => {
                card.classList.remove('drag-over');
            });
            
            draggedElement = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target !== draggedElement) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== e.target) {
                // Get the positions of both cards
                const draggedId = draggedElement.dataset.cardId;
                const targetId = e.target.dataset.cardId;
                
                const draggedIndex = cardOrder.indexOf(draggedId);
                const targetIndex = cardOrder.indexOf(targetId);
                
                // Swap positions in the order array
                cardOrder.splice(draggedIndex, 1);
                cardOrder.splice(targetIndex, 0, draggedId);
                
                // Save new order
                localStorage.setItem('cardOrder', JSON.stringify(cardOrder));
                
                // Reorder the cards
                reorderCards();
                
                showNotification(' 住专 专住 砖专!', 'success');
            }
            
            e.target.classList.remove('drag-over');
            return false;
        }

        function handleContainerDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            return false;
        }

        function reorderCards() {
            const container = document.getElementById('dashboardContainer');
            const allCards = Array.from(container.querySelectorAll('.dashboard-card'));
            
            // Create a map of card elements by their IDs
            const cardMap = {};
            allCards.forEach(card => {
                cardMap[card.dataset.cardId] = card;
            });
            
            // Separate status cards from other cards
            const statusCardIds = ['stability', 'current-inr', 'current-dose', 'tomorrow-dose'];
            const statusCards = [];
            const otherCards = [];
            
            cardOrder.forEach(cardId => {
                if (cardMap[cardId]) {
                    if (statusCardIds.includes(cardId)) {
                        statusCards.push(cardMap[cardId]);
                    } else {
                        otherCards.push(cardMap[cardId]);
                    }
                }
            });
            
            // Rebuild the structure
            const statusCardsContainer = container.querySelector('#statusCards');
            const dashboardSection = container.querySelector('.dashboard-section');
            
            // Clear status cards container
            statusCardsContainer.innerHTML = '';
            
            // Add status cards back to their grid
            statusCards.forEach(card => {
                statusCardsContainer.appendChild(card);
            });
            
            // Remove existing other cards from container
            otherCards.forEach(card => {
                if (card.parentNode) {
                    card.parentNode.removeChild(card);
                }
            });
            
            // Add other cards after the dashboard section
            otherCards.forEach(card => {
                container.appendChild(card);
            });
            
            // Reinitialize drag and drop event listeners for all cards
            const newCards = container.querySelectorAll('.dashboard-card');
            newCards.forEach(card => {
                // Remove existing listeners to prevent duplicates
                card.removeEventListener('dragstart', handleDragStart);
                card.removeEventListener('dragend', handleDragEnd);
                card.removeEventListener('dragover', handleDragOver);
                card.removeEventListener('drop', handleDrop);
                card.removeEventListener('dragenter', handleDragEnter);
                card.removeEventListener('dragleave', handleDragLeave);
                
                // Add listeners back
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
            });
            
            // Reinitialize icons after reordering
            lucide.createIcons();
        }

        function resetCardOrder() {
            if (confirm(' 转  砖专爪 驻住 转 住专 专住 专专转 ?')) {
                localStorage.removeItem('cardOrder');
                cardOrder = ['stability', 'current-inr', 'current-dose', 'tomorrow-dose', 'weekly-plan', 'chart', 'history'];
                reorderCards();
                showNotification(' 住专 专住 驻住 专专转 !', 'success');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initAuth((user) => {
                currentUser = user;
                // Populate User Menu
                document.getElementById('userName').textContent = user.displayName;
                const avatarImg = document.getElementById('userAvatar');
                
                if (user.photoURL) {
                    // Try to load Google avatar, fallback to PNG logo if it fails
                    avatarImg.src = user.photoURL;
                    avatarImg.onerror = function() {
                        this.src = 'INR_Logo_v1.png';
                        this.onerror = null; // Prevent infinite loop
                    };
                } else {
                    // Use PNG logo as default avatar
                    avatarImg.src = 'INR_Logo_v1.png';
                }

                if (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    document.getElementById('adminLink').classList.remove('hidden');
                }
                loadPatientInfo();
                loadData();
                initializeDragAndDrop();
            lucide.createIcons();
            });
            
            // Add form event listener
            document.getElementById('inrForm').addEventListener('submit', handleFormSubmit);
            
            // Add event listeners for target range changes
            document.getElementById('targetMin').addEventListener('change', updateDisplay);
            document.getElementById('targetMax').addEventListener('change', updateDisplay);
            
            // Auto-save patient info when fields change
            ['patientAge', 'patientWeight', 'targetMin', 'targetMax', 'smokingStatus', 'alcoholStatus', 'dietStatus', 'indication', 'liverFunction', 'kidneyFunction', 'genetics', 'activityLevel'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        const db = firebase.firestore();
                        db.collection('users').doc(currentUser.uid).get().then(doc => {
                             if (doc.exists && doc.data().patientInfo && doc.data().patientInfo.saved) {
                                // In edit mode, auto-save changes
                                patientInfo = {
                                    name: document.getElementById('patientName').value,
                                    age: document.getElementById('patientAge').value,
                                    weight: document.getElementById('patientWeight').value,
                                    targetMin: document.getElementById('targetMin').value,
                                    targetMax: document.getElementById('targetMax').value,
                                    smokingStatus: document.getElementById('smokingStatus').value,
                                    alcoholStatus: document.getElementById('alcoholStatus').value,
                                    dietStatus: document.getElementById('dietStatus').value,
                                    indication: document.getElementById('indication').value,
                                    liverFunction: document.getElementById('liverFunction').value,
                                    kidneyFunction: document.getElementById('kidneyFunction').value,
                                    genetics: document.getElementById('genetics').value,
                                    activityLevel: document.getElementById('activityLevel').value,
                                    saved: true
                                };
                                 db.collection('users').doc(currentUser.uid).set({ patientInfo: patientInfo }, { merge: true }).then(() => {
                                showNotification('驻专 驻 注', 'success');
                                updateDisplay();
                                }).catch(error => {
                                     console.error("Error auto-saving patient info: ", error);
                                });
                            }
                        });
                    });
                }
            });
        });

        // Smart Insights Functions
        function generateInsights() {
            const insightsContent = document.getElementById('insightsContent');
            
            if (inrData.length === 0) {
                insightsContent.innerHTML = '<p class="text-indigo-700">住祝 转  拽 转转 转 注 爪.</p>';
                return;
            }

            const sortedData = [...inrData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const targetMin = parseFloat(document.getElementById('targetMin').value) || 2.0;
            const targetMax = parseFloat(document.getElementById('targetMax').value) || 3.0;
            const insights = [];

            // Trend analysis
            if (sortedData.length >= 3) {
                const recent = sortedData.slice(-3);
                const trend = recent[2].inr - recent[0].inr;
                
                if (Math.abs(trend) > 0.3) {
                    const direction = trend > 0 ? '注' : '专';
                    const color = trend > 0 ? 'text-red-700' : 'text-blue-700';
                    const icon = trend > 0 ? 'trending-up' : 'trending-down';
                    insights.push({
                        type: 'trend',
                        icon: icon,
                        color: color,
                        text: `转 ${direction} 砖注转转 -INR 砖砖 转 专转 (${Math.abs(trend).toFixed(1)} 转)`
                    });
                }
            }

            // Stability analysis
            if (sortedData.length >= 5) {
                const lastFive = sortedData.slice(-5);
                const inRange = lastFive.filter(m => m.inr >= targetMin && m.inr <= targetMax).length;
                
                if (inRange >= 4) {
                    insights.push({
                        type: 'stability',
                        icon: 'check-circle',
                        color: 'text-green-700',
                        text: `爪转 爪转! ${inRange} 转 砖 转 专转  注`
                    });
                } else if (inRange <= 2) {
                    insights.push({
                        type: 'instability',
                        icon: 'alert-triangle',
                        color: 'text-orange-700',
                        text: `砖 砖驻专 爪转 - 专拽 ${inRange} 转 砖 转 专转  注`
                    });
                }
            }

            // Medication pattern analysis
            const withMeds = sortedData.filter(m => m.antibiotics || m.painkillers || m.aspirin || m.otherMeds);
            if (withMeds.length > 0) {
                const avgWithMeds = withMeds.reduce((sum, m) => sum + m.inr, 0) / withMeds.length;
                const avgWithoutMeds = sortedData.filter(m => !m.antibiotics && !m.painkillers && !m.aspirin && !m.otherMeds)
                    .reduce((sum, m, _, arr) => sum + m.inr / arr.length, 0);
                
                if (Math.abs(avgWithMeds - avgWithoutMeds) > 0.3) {
                    const effect = avgWithMeds > avgWithoutMeds ? '注转' : '专转';
                    insights.push({
                        type: 'medication',
                        icon: 'pill',
                        color: 'text-purple-700',
                        text: `转专驻转 住驻转 ${effect} 转 -INR 爪注 -${Math.abs(avgWithMeds - avgWithoutMeds).toFixed(1)} 转`
                    });
                }
            }

            // Time since last test
            const daysSinceLastTest = Math.floor((new Date() - new Date(sortedData[sortedData.length - 1].date)) / (1000 * 60 * 60 * 24));
            if (daysSinceLastTest > 30) {
                insights.push({
                    type: 'reminder',
                    icon: 'clock',
                    color: 'text-red-700',
                    text: `注专 ${daysSinceLastTest}  拽 专. 抓 拽 INR 拽专`
                });
            }

            // Render insights
            if (insights.length === 0) {
                insightsContent.innerHTML = '<p class="text-indigo-700"> 转 专 ! 砖 注拽 住专.</p>';
            } else {
                insightsContent.innerHTML = insights.map(insight => `
                    <div class="flex items-start gap-3 p-3 bg-white rounded-lg border border-indigo-100">
                        <i data-lucide="${insight.icon}" class="w-5 h-5 ${insight.color} mt-0.5"></i>
                        <p class="${insight.color} text-sm">${insight.text}</p>
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
        }

        function toggleInsights() {
            const content = document.getElementById('insightsContent');
            const toggle = document.getElementById('insightsToggle');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('hidden');
                toggle.style.transform = 'rotate(180deg)';
            }
        }

        // Quick Actions Functions
        function toggleQuickActions() {
            const menu = document.getElementById('quickActionsMenu');
            const icon = document.getElementById('quickActionIcon');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.style.transform = 'rotate(45deg)';
            } else {
                closeQuickActions();
            }
        }

        function closeQuickActions() {
            const menu = document.getElementById('quickActionsMenu');
            const icon = document.getElementById('quickActionIcon');
            
            menu.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }

        function scrollToForm() {
            document.getElementById('measurement-form').scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
        }

        // PDF Report Generation
        function generateReport() {
            if (inrData.length === 0) {
                showNotification(' 转 爪专转 ', 'error');
                return;
            }
            
            showNotification('驻爪\'专  PDF 转住祝 拽专', 'info');
        }

        function generateReportContent() {
            const sortedData = [...inrData].sort((a, b) => new Date(a.date) - new Date(b.date));
            const targetMin = parseFloat(document.getElementById('targetMin').value) || 2.0;
            const targetMax = parseFloat(document.getElementById('targetMax').value) || 3.0;
            
            const inRangeCount = sortedData.filter(m => m.inr >= targetMin && m.inr <= targetMax).length;
            const inRangePercent = ((inRangeCount / sortedData.length) * 100).toFixed(1);
            
            const currentDate = new Date().toLocaleDateString('he-IL');
            
            return `
                <div class="header">
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <img src="INR_Logo_v1.png" alt="INR Assistant Logo" style="height: 60px; width: 60px; margin-left: 15px;">
                        <div>
                            <h1> 注拽 INR</h1>
                            <p style="color: #666; font-size: 14px;">注专 拽  - INR Assistant</p>
                        </div>
                    </div>
                    <p><strong>砖 驻:</strong> ${patientInfo.name || ' 爪'}</p>
                    <p><strong>转专 :</strong> ${currentDate}</p>
                    <p><strong> 注:</strong> ${targetMin.toFixed(1)} - ${targetMax.toFixed(1)}</p>
                </div>

                <div class="section">
                    <h2>住 住住</h2>
                    <div class="summary">
                        <p><strong>住" 转:</strong> ${sortedData.length}</p>
                        <p><strong>转  注:</strong> ${inRangeCount} (${inRangePercent}%)</p>
                        <p><strong>INR 专:</strong> ${sortedData[sortedData.length - 1].inr.toFixed(1)} (${formatDate(sortedData[sortedData.length - 1].date)})</p>
                        <p><strong> 专:</strong> ${sortedData[sortedData.length - 1].dose.toFixed(1)} "</p>
                    </div>
                </div>

                <div class="section">
                    <h2>住专转 转</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>转专</th>
                                <th>INR</th>
                                <th> (")</th>
                                <th>住住</th>
                                <th>注专转</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedData.map(measurement => `
                                <tr>
                                    <td>${formatDate(measurement.date)}</td>
                                    <td>${measurement.inr.toFixed(1)}</td>
                                    <td>${measurement.dose.toFixed(1)}</td>
                                    <td>${getINRStatusText(measurement.inr, targetMin, targetMax)}</td>
                                    <td>${measurement.symptoms || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Notification System Enhancement
        function showAdvancedNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                warning: 'alert-triangle',
                info: 'info'
            };
            
            const colors = {
                success: 'bg-green-500 border-green-600',
                error: 'bg-red-500 border-red-600',
                warning: 'bg-yellow-500 border-yellow-600',
                info: 'bg-blue-500 border-blue-600'
            };
            
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${colors[type]} text-white border-l-4 transform translate-x-full transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-lucide="${icons[type]}" class="w-5 h-5"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="mr-auto">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            lucide.createIcons();
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(full)';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

                         // Dashboard Width Control
        function setDashboardWidth(size) {
            const mainContainer = document.getElementById('mainContainer');
            const explanationsContainer = document.getElementById('explanationsContainer');
            
            // Remove all width classes from both containers
            [mainContainer, explanationsContainer].forEach(container => {
                if (container) {
                    container.classList.remove('dashboard-width-small', 'dashboard-width-medium', 'dashboard-width-large');
                    container.classList.add(`dashboard-width-${size}`);
                }
            });
            
            // Update the button icon
            const labels = {
                small: { text: '爪专', icon: 'smartphone' },
                medium: { text: '', icon: 'tablet' },
                large: { text: '专', icon: 'monitor' }
            };
            
            const button = document.getElementById('width-menu-button');
            const icon = button.querySelector('i[data-lucide]');
            icon.setAttribute('data-lucide', labels[size].icon);
            
            // Save preference to localStorage
            localStorage.setItem('dashboardWidth', size);
            
            // Re-render icons and show notification
            lucide.createIcons();
            showNotification(`转爪 砖转 ${labels[size].text}`, 'success');
            
            // Update menu selection highlight
            updateWidthMenuSelection(size);
        }
        
        function updateWidthMenuSelection(selectedSize) {
            const menuItems = document.querySelectorAll('#width-menu a');
            menuItems.forEach(item => {
                item.classList.remove('bg-blue-50');
                if (item.getAttribute('onclick').includes(`'${selectedSize}'`)) {
                    item.classList.add('bg-blue-50');
                }
            });
        }
        
        function loadDashboardWidth() {
            const savedWidth = localStorage.getItem('dashboardWidth') || 'large';
            // Load width without showing notification on initial load
            const mainContainer = document.getElementById('mainContainer');
            const explanationsContainer = document.getElementById('explanationsContainer');
            
            [mainContainer, explanationsContainer].forEach(container => {
                if (container) {
                    container.classList.remove('dashboard-width-small', 'dashboard-width-medium', 'dashboard-width-large');
                    container.classList.add(`dashboard-width-${savedWidth}`);
                }
            });
            
            const labels = {
                small: { icon: 'smartphone' },
                medium: { icon: 'tablet' },
                large: { icon: 'monitor' }
            };
            
            const button = document.getElementById('width-menu-button');
            const icon = button.querySelector('i[data-lucide]');
            icon.setAttribute('data-lucide', labels[savedWidth].icon);
            
            updateWidthMenuSelection(savedWidth);
            lucide.createIcons();
        }

        // Font Scale Control Functions
        function setFontScale(scale) {
            const body = document.body;
            
            // Remove all font scale classes
            body.classList.remove('font-scale-small', 'font-scale-normal', 'font-scale-large', 'font-scale-xl', 'font-scale-xxl');
            body.classList.add(`font-scale-${scale}`);
            
            // Update the button icon and text
            const labels = {
                small: { text: '拽', icon: 'minus', size: '14px' },
                normal: { text: '专', icon: 'type', size: '16px' },
                large: { text: '', icon: 'plus', size: '18px' },
                xl: { text: ' ', icon: 'plus-circle', size: '20px' },
                xxl: { text: '注拽', icon: 'maximize-2', size: '22px' }
            };
            
            const button = document.getElementById('font-menu-button');
            const icon = button.querySelector('i[data-lucide]');
            const span = button.querySelector('span');
            
            icon.setAttribute('data-lucide', labels[scale].icon);
            span.textContent = `驻 ${labels[scale].text}`;
            
            // Save preference to localStorage
            localStorage.setItem('fontScale', scale);
            
            // Re-render icons and show notification
            lucide.createIcons();
            showNotification(` 驻 砖 ${labels[scale].text} (${labels[scale].size})`, 'success');
            
            // Update menu selection highlight
            updateFontMenuSelection(scale);
        }
        
        function updateFontMenuSelection(selectedScale) {
            const menuItems = document.querySelectorAll('#font-menu a');
            menuItems.forEach(item => {
                item.classList.remove('bg-blue-50');
                if (item.getAttribute('onclick').includes(`'${selectedScale}'`)) {
                    item.classList.add('bg-blue-50');
                }
            });
        }
        
        function loadFontScale() {
            const savedScale = localStorage.getItem('fontScale') || 'normal';
            
            // Apply font scale without showing notification
            const body = document.body;
            body.classList.remove('font-scale-small', 'font-scale-normal', 'font-scale-large', 'font-scale-xl', 'font-scale-xxl');
            body.classList.add(`font-scale-${savedScale}`);
            
            const labels = {
                small: { text: '拽', icon: 'minus' },
                normal: { text: '专', icon: 'type' },
                large: { text: '', icon: 'plus' },
                xl: { text: ' ', icon: 'plus-circle' },
                xxl: { text: '注拽', icon: 'maximize-2' }
            };
            
            const button = document.getElementById('font-menu-button');
            if (button) {
                const icon = button.querySelector('i[data-lucide]');
                const span = button.querySelector('span');
                
                icon.setAttribute('data-lucide', labels[savedScale].icon);
                span.textContent = `驻 ${labels[savedScale].text}`;
                
                updateFontMenuSelection(savedScale);
                lucide.createIcons();
            }
        }

        // Initialize insights and load preferences on load
        document.addEventListener('DOMContentLoaded', function() {
            generateInsights();
            loadDashboardWidth();
            loadFontScale();
        });
    </script>

    <!-- Quick Actions Floating Button -->
    <div class="fixed bottom-6 left-6 z-40">
        <div class="relative">
            <button onclick="toggleQuickActions()" class="bg-gradient-to-br from-red-500 to-blue-600 hover:from-red-600 hover:to-blue-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-110">
                <i data-lucide="plus" class="w-6 h-6" id="quickActionIcon"></i>
            </button>
            <div id="quickActionsMenu" class="hidden absolute bottom-16 left-0 bg-white rounded-lg shadow-xl border p-2 min-w-48">
                <button onclick="scrollToForm(); closeQuickActions();" class="w-full text-right px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-3">
                    <i data-lucide="plus-circle" class="w-4 h-4 text-blue-600"></i>
                    住祝 
                </button>
                <button onclick="exportData(); closeQuickActions();" class="w-full text-right px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-3">
                    <i data-lucide="download" class="w-4 h-4 text-green-600"></i>
                    爪 转
                </button>
                <button onclick="generateReport(); closeQuickActions();" class="w-full text-right px-3 py-2 hover:bg-gray-100 rounded flex items-center gap-3">
                    <i data-lucide="file-text" class="w-4 h-4 text-purple-600"></i>
                     专驻
                </button>
            </div>
        </div>
    </div>

</body>
</html>
