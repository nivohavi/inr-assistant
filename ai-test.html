<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª AI - × ×™×ª×•×— ×ª×–×•× ×”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="setup-secure.js"></script>
    <script src="ai-integration.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">×‘×“×™×§×ª × ×™×ª×•×— AI ×œ×ª×–×•× ×”</h1>
        
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">×”×–×Ÿ × ×ª×•× ×™ ×ª×–×•× ×” ×œ×‘×“×™×§×”</h2>
                <div id="aiStatus" class="text-sm px-3 py-1 rounded-full bg-gray-100 text-gray-600">
                    <span id="aiStatusText">×‘×•×“×§ ×ª×¦×•×¨×”...</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">××” ××›×œ×ª×™ ×”×™×•×?</label>
                    <textarea id="dietToday" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="×ª××¨ ××ª ×”××¨×•×—×•×ª ×©×œ×š ×”×™×•×..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">××” ×× ×™ ××ª×›× ×Ÿ ×œ××›×•×œ ××—×¨?</label>
                    <textarea id="dietTomorrow" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="×ª××¨ ××ª ×”××¨×•×—×•×ª ×”××ª×•×›× × ×•×ª ×œ××—×¨..."></textarea>
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="testAnalysis()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200 flex items-center gap-2">
                    <i data-lucide="brain" class="w-5 h-5"></i>
                    ×‘×“×•×§ × ×™×ª×•×— AI
                </button>
            </div>
        </div>
        
        <div id="results" class="hidden">
            <!-- Results will be populated here -->
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-8">
            <h3 class="text-lg font-semibold text-blue-800 mb-4">×“×•×’×××•×ª ×œ×‘×“×™×§×”:</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">×“×•×’××” 1: ×¦×¨×™×›×” ×’×‘×•×”×” ×©×œ ×•×™×˜××™×Ÿ K</h4>
                    <p class="text-sm text-gray-600">×”×™×•×: ×›×¨×•×‘ ××‘×•×©×œ, ×‘×¨×•×§×•×œ×™, ×ª×¨×“</p>
                    <p class="text-sm text-gray-600">××—×¨: ×¡×œ×˜ ×—×¡×”, ××¡×¤×¨×’×•×¡</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">×“×•×’××” 2: ××œ×›×•×”×•×œ</h4>
                    <p class="text-sm text-gray-600">×”×™×•×: ×™×™×Ÿ ××“×•× ×¢× ×”××¨×•×—×”</p>
                    <p class="text-sm text-gray-600">××—×¨: ××•×›×œ ×¨×’×™×œ</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">×“×•×’××” 3: ××©×›×•×œ×™×ª</h4>
                    <p class="text-sm text-gray-600">×”×™×•×: ××™×¥ ××©×›×•×œ×™×ª ×‘×‘×•×§×¨</p>
                    <p class="text-sm text-gray-600">××—×¨: ××•×›×œ ×¨×’×™×œ</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">×“×•×’××” 4: ×ª×–×•× ×” ×§×‘×•×¢×”</h4>
                    <p class="text-sm text-gray-600">×”×™×•×: ××•×›×œ ×¨×’×™×œ, ××¢×˜ ×™×¨×§×•×ª</p>
                    <p class="text-sm text-gray-600">××—×¨: ××•×›×œ ×“×•××”</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Check AI configuration status
        function updateAIStatus() {
            const statusDiv = document.getElementById('aiStatus');
            const statusText = document.getElementById('aiStatusText');
            
            if (window.secureConfig) {
                const aiConfig = window.secureConfig.getAIConfig();
                if (aiConfig.OPENAI_API_KEY && aiConfig.OPENAI_API_KEY !== 'your-openai-api-key-here') {
                    statusDiv.className = 'text-sm px-3 py-1 rounded-full bg-green-100 text-green-700';
                    statusText.textContent = 'ğŸ¤– AI ×××™×ª×™ ×–××™×Ÿ';
                } else {
                    statusDiv.className = 'text-sm px-3 py-1 rounded-full bg-yellow-100 text-yellow-700';
                    statusText.textContent = 'ğŸ§ª AI ××“×•××”';
                }
            } else {
                statusDiv.className = 'text-sm px-3 py-1 rounded-full bg-red-100 text-red-700';
                statusText.textContent = 'âŒ ×ª×¦×•×¨×” ×—×¡×¨×”';
            }
        }
        
        // Update status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateAIStatus, 1000); // Wait for scripts to load
        });
        
        // Mock patient info for testing
        const mockPatientInfo = {
            name: '××˜×•×¤×œ ×‘×“×™×§×”',
            age: 65,
            weight: 70,
            targetMin: 2.0,
            targetMax: 3.0
        };
        
        // Mock INR data for testing
        const mockInrData = [
            { date: '2024-01-01', inr: 2.5, dose: 5.0 },
            { date: '2024-01-08', inr: 2.8, dose: 5.0 },
            { date: '2024-01-15', inr: 2.3, dose: 5.0 }
        ];
        
        // Copy the AI analysis functions from the main app
        async function testAnalysis() {
            const dietToday = document.getElementById('dietToday').value.trim();
            const dietTomorrow = document.getElementById('dietTomorrow').value.trim();
            
            if (!dietToday && !dietTomorrow) {
                alert('×× × ×”×–×Ÿ ×œ×¤×—×•×ª ×ª×–×•× ×” ×©×œ ×”×™×•× ××• ×©×œ ××—×¨ ×œ× ×™×ª×•×—');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                        <span class="text-purple-600 font-medium">×× ×ª×— ×ª×–×•× ×”...</span>
                    </div>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
            
            try {
                const analysis = await performDietAnalysis(dietToday, dietTomorrow);
                displayTestResults(analysis);
            } catch (error) {
                console.error('Analysis error:', error);
                resultsDiv.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="text-red-600 text-center">
                            <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
                            <p>×©×’×™××” ×‘× ×™×ª×•×—. × ×¡×” ×©×•×‘.</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        async function performDietAnalysis(dietToday, dietTomorrow) {
            const context = {
                patientInfo: mockPatientInfo,
                targetRange: { min: 2.0, max: 3.0 },
                currentINR: 2.3,
                currentDose: 5.0,
                dietToday: dietToday,
                dietTomorrow: dietTomorrow,
                recentMeasurements: mockInrData
            };
            
            // Try real AI first, fallback to mock
            try {
                if (window.secureConfig && window.secureConfig.getAIConfig().OPENAI_API_KEY) {
                    console.log('ğŸ¤– Using real AI analysis...');
                    const aiAnalyzer = new AIAnalyzer(window.secureConfig.getAIConfig().OPENAI_API_KEY);
                    return await aiAnalyzer.analyzeDiet({ dietToday, dietTomorrow }, context);
                } else {
                    console.log('ğŸ§ª Using mock AI analysis...');
                    return await localDietAnalysis(context);
                }
            } catch (error) {
                console.warn('Real AI failed, using mock:', error);
                return await localDietAnalysis(context);
            }
        }
        
        async function localDietAnalysis(context) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const analysis = {
                vitaminKImpact: analyzeVitaminKContent(context.dietToday, context.dietTomorrow),
                dietaryInteractions: analyzeDietaryInteractions(context),
                recommendations: generateDietaryRecommendations(context),
                riskAssessment: assessDietaryRisks(context),
                doseAdjustment: calculateDoseAdjustment(context)
            };
            
            return analysis;
        }
        
        function analyzeVitaminKContent(dietToday, dietTomorrow) {
            const vitaminKFoods = {
                '×›×¨×•×‘': 'high',
                '×‘×¨×•×§×•×œ×™': 'high',
                '×ª×¨×“': 'high',
                '×—×¡×”': 'medium',
                '××¡×¤×¨×’×•×¡': 'medium',
                '××‘×•×§×“×•': 'medium',
                '×©××Ÿ ×–×™×ª': 'low',
                '×‘×™×¦×™×': 'low',
                '×—×œ×‘': 'low'
            };
            
            const todayImpact = calculateFoodImpact(dietToday, vitaminKFoods);
            const tomorrowImpact = calculateFoodImpact(dietTomorrow, vitaminKFoods);
            
            return {
                today: todayImpact,
                tomorrow: tomorrowImpact,
                overall: (todayImpact + tomorrowImpact) / 2
            };
        }
        
        function calculateFoodImpact(diet, foodImpact) {
            if (!diet) return 0;
            
            let impact = 0;
            const dietLower = diet.toLowerCase();
            
            Object.keys(foodImpact).forEach(food => {
                if (dietLower.includes(food.toLowerCase())) {
                    switch (foodImpact[food]) {
                        case 'high': impact += 2; break;
                        case 'medium': impact += 1; break;
                        case 'low': impact += 0.5; break;
                    }
                }
            });
            
            return Math.min(impact, 5);
        }
        
        function analyzeDietaryInteractions(context) {
            const interactions = [];
            
            if (context.dietToday.toLowerCase().includes('×™×™×Ÿ') || 
                context.dietToday.toLowerCase().includes('×‘×™×¨×”') ||
                context.dietToday.toLowerCase().includes('××œ×›×•×”×•×œ')) {
                interactions.push({
                    type: 'alcohol',
                    severity: 'medium',
                    description: '××œ×›×•×”×•×œ ×™×›×•×œ ×œ×”×’×‘×™×¨ ××ª ×”×©×¤×¢×ª ×”×§×•××“×™×Ÿ',
                    recommendation: '×”×™×× ×¢ ×××œ×›×•×”×•×œ ××• ×”×’×‘×œ ×œ×›××•×ª ×§×˜× ×”'
                });
            }
            
            if (context.dietToday.toLowerCase().includes('××©×›×•×œ×™×ª') ||
                context.dietTomorrow.toLowerCase().includes('××©×›×•×œ×™×ª')) {
                interactions.push({
                    type: 'grapefruit',
                    severity: 'high',
                    description: '××©×›×•×œ×™×ª ××©×¤×™×¢×” ×¢×œ ×¤×™×¨×•×§ ×”×§×•××“×™×Ÿ ×‘×›×‘×“',
                    recommendation: '×”×™×× ×¢ ×××©×›×•×œ×™×ª ×•××™×¥ ××©×›×•×œ×™×ª'
                });
            }
            
            return interactions;
        }
        
        function generateDietaryRecommendations(context) {
            const recommendations = [];
            
            const todayK = calculateFoodImpact(context.dietToday, {
                '×›×¨×•×‘': 'high', '×‘×¨×•×§×•×œ×™': 'high', '×ª×¨×“': 'high'
            });
            const tomorrowK = calculateFoodImpact(context.dietTomorrow, {
                '×›×¨×•×‘': 'high', '×‘×¨×•×§×•×œ×™': 'high', '×ª×¨×“': 'high'
            });
            
            if (todayK === 0 && tomorrowK > 0) {
                recommendations.push({
                    type: 'vitamin_k_increase',
                    description: '×”×•×¡×¤×ª ×™×¨×§×•×ª ×¢×œ×™×™× ××—×¨ ×¢×œ×•×œ×” ×œ×”×¤×—×™×ª ××ª ×”-INR',
                    action: '×©×§×•×œ ×œ×”×’×“×™×œ ××ª ×”××™× ×•×Ÿ ×‘-0.5 ×"×’ ×œ××—×¨'
                });
            } else if (todayK > 0 && tomorrowK === 0) {
                recommendations.push({
                    type: 'vitamin_k_decrease',
                    description: '×”×¤×—×ª×ª ×™×¨×§×•×ª ×¢×œ×™×™× ××—×¨ ×¢×œ×•×œ×” ×œ×”×’×‘×™×¨ ××ª ×”-INR',
                    action: '×©×§×•×œ ×œ×”×¤×—×™×ª ××ª ×”××™× ×•×Ÿ ×‘-0.5 ×"×’ ×œ××—×¨'
                });
            }
            
            return recommendations;
        }
        
        function assessDietaryRisks(context) {
            const risks = [];
            
            const todayK = calculateFoodImpact(context.dietToday, {
                '×›×¨×•×‘': 'high', '×‘×¨×•×§×•×œ×™': 'high', '×ª×¨×“': 'high'
            });
            
            if (todayK > 3) {
                risks.push({
                    level: 'medium',
                    description: '×¦×¨×™×›×” ×’×‘×•×”×” ×©×œ ×•×™×˜××™×Ÿ K ×”×™×•×',
                    impact: '×¢×œ×•×œ ×œ×”×¤×—×™×ª ××ª ×”-INR'
                });
            }
            
            if (context.dietToday.toLowerCase().includes('×™×™×Ÿ') || 
                context.dietToday.toLowerCase().includes('×‘×™×¨×”')) {
                risks.push({
                    level: 'high',
                    description: '×¦×¨×™×›×ª ××œ×›×•×”×•×œ',
                    impact: '×¢×œ×•×œ ×œ×”×’×‘×™×¨ ××ª ×”×©×¤×¢×ª ×”×§×•××“×™×Ÿ ×•×œ×”×’×‘×™×¨ ×¡×™×›×•×Ÿ ×œ×“×™××•×'
                });
            }
            
            return risks;
        }
        
        function calculateDoseAdjustment(context) {
            let adjustment = 0;
            let reason = '';
            
            const todayK = calculateFoodImpact(context.dietToday, {
                '×›×¨×•×‘': 'high', '×‘×¨×•×§×•×œ×™': 'high', '×ª×¨×“': 'high'
            });
            const tomorrowK = calculateFoodImpact(context.dietTomorrow, {
                '×›×¨×•×‘': 'high', '×‘×¨×•×§×•×œ×™': 'high', '×ª×¨×“': 'high'
            });
            
            if (tomorrowK - todayK > 1.5) {
                adjustment += 0.5;
                reason = '×”×’×“×œ×ª ×¦×¨×™×›×ª ×•×™×˜××™×Ÿ K ××—×¨';
            } else if (todayK - tomorrowK > 1.5) {
                adjustment -= 0.5;
                reason = '×”×¤×—×ª×ª ×¦×¨×™×›×ª ×•×™×˜××™×Ÿ K ××—×¨';
            }
            
            return {
                adjustment: adjustment,
                reason: reason,
                recommendedDose: context.currentDose ? context.currentDose + adjustment : null
            };
        }
        
        function displayTestResults(analysis) {
            const resultsDiv = document.getElementById('results');
            
            // Check if this is a real AI response or mock
            const isRealAI = analysis && typeof analysis === 'object' && analysis.vitaminKImpact === undefined;
            
            if (isRealAI) {
                // Real AI response - use the display function from ai-integration.js
                displayDietAnalysis(analysis);
                return;
            }
            
            // Mock AI response - use the original display logic
            let html = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                        <i data-lucide="brain" class="w-6 h-6 text-purple-600"></i>
                        ×ª×•×¦××•×ª × ×™×ª×•×— AI (Mock)
                    </h3>
                    <div class="space-y-4">
            `;
            
            // Vitamin K Impact
            if (analysis.vitaminKImpact.overall > 0) {
                html += `
                    <div class="bg-blue-50 p-4 rounded-lg border-r-4 border-blue-400">
                        <h4 class="font-semibold text-blue-800 mb-2">ğŸƒ ×”×©×¤×¢×ª ×•×™×˜××™×Ÿ K</h4>
                        <p class="text-blue-700 text-sm">×¦×¨×™×›×ª ×•×™×˜××™×Ÿ K: ${analysis.vitaminKImpact.overall.toFixed(1)}/5</p>
                        <p class="text-blue-600 text-xs">${analysis.vitaminKImpact.overall > 2 ? '×¦×¨×™×›×” ×’×‘×•×”×” - ×¢×œ×•×œ ×œ×”×¤×—×™×ª INR' : '×¦×¨×™×›×” ××ª×•× ×” - ×™×¦×™×‘'}</p>
                    </div>
                `;
            }
            
            // Dietary Interactions
            if (analysis.dietaryInteractions.length > 0) {
                html += `
                    <div class="bg-orange-50 p-4 rounded-lg border-r-4 border-orange-400">
                        <h4 class="font-semibold text-orange-800 mb-2">âš ï¸ ××™× ×˜×¨××§×¦×™×•×ª ×ª×–×•× ×ª×™×•×ª</h4>
                        ${analysis.dietaryInteractions.map(interaction => `
                            <div class="mb-2">
                                <p class="text-orange-700 text-sm font-medium">${interaction.description}</p>
                                <p class="text-orange-600 text-xs">${interaction.recommendation}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Recommendations
            if (analysis.recommendations.length > 0) {
                html += `
                    <div class="bg-green-50 p-4 rounded-lg border-r-4 border-green-400">
                        <h4 class="font-semibold text-green-800 mb-2">ğŸ’¡ ×”××œ×¦×•×ª</h4>
                        ${analysis.recommendations.map(rec => `
                            <div class="mb-2">
                                <p class="text-green-700 text-sm">${rec.description}</p>
                                <p class="text-green-600 text-xs font-medium">${rec.action}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Risk Assessment
            if (analysis.riskAssessment.length > 0) {
                html += `
                    <div class="bg-red-50 p-4 rounded-lg border-r-4 border-red-400">
                        <h4 class="font-semibold text-red-800 mb-2">ğŸš¨ ×”×¢×¨×›×ª ×¡×™×›×•× ×™×</h4>
                        ${analysis.riskAssessment.map(risk => `
                            <div class="mb-2">
                                <p class="text-red-700 text-sm font-medium">${risk.description}</p>
                                <p class="text-red-600 text-xs">${risk.impact}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Dose Adjustment
            if (analysis.doseAdjustment.adjustment !== 0) {
                const adjustmentColor = analysis.doseAdjustment.adjustment > 0 ? 'green' : 'orange';
                html += `
                    <div class="bg-${adjustmentColor}-50 p-4 rounded-lg border-r-4 border-${adjustmentColor}-400">
                        <h4 class="font-semibold text-${adjustmentColor}-800 mb-2">ğŸ’Š ×”×ª×××ª ××™× ×•×Ÿ ××•××œ×¦×ª</h4>
                        <p class="text-${adjustmentColor}-700 text-sm">${analysis.doseAdjustment.reason}</p>
                        <p class="text-${adjustmentColor}-600 text-xs font-medium">
                            ××™× ×•×Ÿ ××•××œ×¥ ×œ××—×¨: ${analysis.doseAdjustment.recommendedDose.toFixed(1)} ×"×’
                        </p>
                    </div>
                `;
            }
            
            if (html.includes('space-y-4')) {
                html += `</div></div>`;
            } else {
                html = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="bg-gray-50 p-4 rounded-lg border-r-4 border-gray-400">
                            <p class="text-gray-700 text-sm">×œ× ×–×•×”×• ×”×©×¤×¢×•×ª ××©××¢×•×ª×™×•×ª ×©×œ ×”×ª×–×•× ×” ×¢×œ ×”-INR</p>
                            <p class="text-gray-600 text-xs">×”××©×š ×‘×ª×–×•× ×” ×”×§×‘×•×¢×” ×©×œ×š</p>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            lucide.createIcons();
        }
    </script>
</body>
</html> 